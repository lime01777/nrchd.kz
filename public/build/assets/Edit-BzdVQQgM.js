import{r as g,W as G,j as e,a as H}from"./app-Cg-aiRh8.js";import{A as K}from"./AdminLayout-BBGvqktT.js";import{M as Q,a as V,b as J}from"./MediaManager-IUgHvcJX.js";import"./transition--wkYrX6_.js";import"./use-is-mounted-DKJQzBpD.js";import"./SafeImage-p-xU4kDM.js";import"./SafeVideo-Ct1vMtWD.js";import"./mediaUtils-oRnee45q.js";const j=["Общие","Аккредитация","Обучение","Конференции","Методические материалы","Исследования","Филиалы","Анонсы событий"];function X({news:s=null}){const N=!!s,[A,p]=g.useState(!1),{data:r,setData:n,post:O,put:z,processing:E,errors:d}=G({title:(s==null?void 0:s.title)||"",category:Array.isArray(s==null?void 0:s.category)?s.category:s!=null&&s.category?[s.category]:[],content:typeof(s==null?void 0:s.content)=="string"?s.content:"",images:(s==null?void 0:s.images)||[],status:(s==null?void 0:s.status)||"Черновик",publishDate:(s==null?void 0:s.publishDate)||new Date().toISOString().substr(0,10)});g.useEffect(()=>{s&&console.log("Загруженные данные новости:",{title:s.title,images:s.images,main_image:s.main_image})},[s]);const[h,D]=g.useState(()=>{if(s!=null&&s.category){const t=Array.isArray(s.category)?s.category:[s.category];return Array.from(new Set([...j,...t]))}return j}),[u,f]=g.useState(Array.isArray(r.category)?r.category:r.category?[r.category]:[]),[C,L]=g.useState(""),[v,F]=g.useState(!1),[x,M]=g.useState(r.images||[]),[w,Y]=g.useState(!1);console.log("NewsEdit - данные новости:",{news:s,data:r,images:r.images,imagesType:typeof r.images}),g.useEffect(()=>{r.images&&r.images.length>0&&M(r.images)},[]),g.useEffect(()=>{const t=a=>{v&&!a.target.closest(".category-dropdown")&&F(!1)};return document.addEventListener("mousedown",t),()=>{document.removeEventListener("mousedown",t)}},[v]);const I=t=>{console.log("Edit - изменение изображений:",t);const a=Array.isArray(t)?t:[];M(a);const o=[],i=[];a.forEach(c=>{c instanceof File?o.push(c):typeof c=="string"&&c.trim().length>0&&i.push(c)}),console.log("Edit - разделенные файлы и URL:",{files:o,urls:i,totalImages:a.length}),n(c=>({...c,images:i,image_files:o}))},_=(t,a)=>{let o;a?o=[...u,t]:o=u.filter(i=>i!==t),f(o),n("category",o)},U=()=>{const t=C.trim();if(!t){alert("Введите название категории");return}if(h.includes(t)){alert("Такая категория уже существует");return}if(t.length<2){alert("Название категории должно содержать минимум 2 символа");return}if(t.length>50){alert("Название категории не должно превышать 50 символов");return}const a=[...h,t];D(a);const o=[...u,t];f(o),n("category",o),L("")},B=t=>{if(!confirm(`Вы уверены, что хотите удалить категорию "${t}"?`))return;const a=u.filter(i=>i!==t);f(a),n("category",a);const o=h.filter(i=>i!==t);D(o)},R=()=>{f([...h]),n("category",[...h])},q=()=>{f([]),n("category",[])},P=()=>{const t=h.filter(a=>!u.includes(a));f(t),n("category",t)},T=t=>{t.preventDefault(),p(!0);try{const a=r.category||[];if(console.log("Изображения перед отправкой:",{images:x,data_images:r.images}),!r.title||r.title.trim().length===0){alert("Заполните заголовок"),p(!1);return}if(Array.isArray(r.category)||n("category",typeof r.category=="string"?[r.category]:[]),typeof r.content!="string"&&n("content",String(r.content||"")),["Черновик","Опубликовано","Запланировано"].includes(r.status)||n("status","Черновик"),!r.content||r.content.replace(/<[^>]*?>/g,"").trim().length<10){alert("Содержимое должно содержать минимум 10 символов"),p(!1);return}if(a.length===0){alert("Выберите хотя бы одну категорию"),p(!1);return}console.log("Состояние изображений перед валидацией:",{images:x,imagesLength:x?x.length:0,imagesType:typeof x});const o=x.filter(l=>{const m=l&&(typeof l=="string"||l instanceof File&&l.size>0);return m||console.warn("Невалидное изображение:",l),m});console.log("Валидные изображения:",o);const i=[],c=[],k=[],S=[];o.forEach(l=>{var m;if(l instanceof File)console.log("Добавляем файл:",l.name,l.size),l.type.startsWith("video/")?c.push(l):i.push(l);else if(typeof l=="string"){console.log("Добавляем URL:",l);const y=(m=l.split(".").pop())==null?void 0:m.toLowerCase();["mp4","avi","mov","wmv","flv","webm"].includes(y)?S.push(l):k.push(l)}}),console.log("Финальное разделение:",{imageFiles:i,videoFiles:c,imageUrls:k,videoUrls:S});const b={title:r.title,content:r.content,status:r.status,publishDate:r.publishDate||"",category:a,images:[...k,...S]};i.length>0&&(b.image_files=i),c.length>0&&(b.video_files=c),console.log("Финальные данные для отправки:",b);const W={preserveScroll:!0,forceFormData:i.length>0||c.length>0,onSuccess:l=>{console.log("Успешное сохранение:",l),p(!1)},onError:l=>{console.error("Ошибки валидации:",l),p(!1);const m=[];Object.keys(l).forEach(y=>{Array.isArray(l[y])?m.push(...l[y]):m.push(l[y])}),m.length>0&&alert(`Ошибки валидации:
`+m.join(`
`))},onFinish:()=>{p(!1)}};N?z(route("admin.news.update",s.id),b,W):O(route("admin.news.store"),b,W)}catch(a){console.error("Ошибка при отправке формы:",a),p(!1),alert("Произошла ошибка при отправке формы")}},$=t=>{n("content",t)};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-6 flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:N?"Редактирование новости":"Создание новости"}),e.jsxs(H,{href:route("admin.news"),className:"inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:[e.jsx("svg",{className:"h-5 w-5 mr-2",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M10 19l-7-7m0 0l7-7m-7 7h18"})}),"Назад к списку"]})]}),e.jsx("div",{className:"bg-white shadow overflow-hidden sm:rounded-lg",children:e.jsxs("form",{onSubmit:T,className:"min-h-full",children:[e.jsx("div",{className:"px-4 py-5 sm:p-6",children:e.jsxs("div",{className:"grid grid-cols-1 gap-6 sm:grid-cols-6",children:[e.jsxs("div",{className:"sm:col-span-6",children:[e.jsx("label",{htmlFor:"title",className:"block text-sm font-medium text-gray-700",children:"Заголовок *"}),e.jsx("div",{className:"mt-1",children:e.jsx("input",{type:"text",name:"title",id:"title",value:r.title,onChange:t=>n("title",t.target.value),className:"shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md",required:!0,placeholder:"Введите заголовок новости"})}),d.title&&e.jsx("p",{className:"mt-2 text-sm text-red-600",children:d.title})]}),e.jsxs("div",{className:"sm:col-span-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Категории *"}),e.jsxs("div",{className:"relative category-dropdown",children:[e.jsxs("button",{type:"button",onClick:()=>F(!v),className:"w-full flex items-center justify-between px-3 py-2 border border-gray-300 rounded-md bg-white text-left text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("span",{className:u.length>0?"text-gray-900":"text-gray-500",children:u.length>0?`Выбрано: ${u.length} категорий`:"Выберите категории..."}),e.jsx("svg",{className:"w-5 h-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 9l-7 7-7-7"})})]}),v&&e.jsx("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto",children:e.jsxs("div",{className:"p-2",children:[e.jsxs("div",{className:"flex gap-2 mb-3 pb-2 border-b border-gray-200",children:[e.jsx("button",{type:"button",onClick:R,className:"px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600",children:"Выбрать все"}),e.jsx("button",{type:"button",onClick:q,className:"px-2 py-1 text-xs bg-gray-600 text-white rounded hover:bg-gray-700",children:"Снять выбор"}),e.jsx("button",{type:"button",onClick:P,className:"px-2 py-1 text-xs bg-purple-500 text-white rounded hover:bg-purple-600",children:"Инвертировать"})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("h5",{className:"text-xs font-medium text-gray-600 mb-2 uppercase tracking-wide",children:"Стандартные категории"}),e.jsx("div",{className:"space-y-1",children:h.filter(t=>j.includes(t)).map(t=>e.jsxs("label",{className:"flex items-center justify-between p-2 hover:bg-gray-50 rounded cursor-pointer",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",checked:u.includes(t),onChange:a=>_(t,a.target.checked),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),e.jsx("span",{className:"ml-2 text-sm text-gray-700",children:t})]}),e.jsx("span",{className:"text-xs text-gray-400 px-2 py-1 bg-gray-100 rounded",children:"Стандартная"})]},t))})]}),h.filter(t=>!j.includes(t)).length>0&&e.jsxs("div",{className:"mb-3",children:[e.jsx("h5",{className:"text-xs font-medium text-gray-600 mb-2 uppercase tracking-wide",children:"Пользовательские категории"}),e.jsx("div",{className:"space-y-1",children:h.filter(t=>!j.includes(t)).map(t=>e.jsxs("label",{className:"flex items-center justify-between p-2 hover:bg-gray-50 rounded cursor-pointer",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",checked:u.includes(t),onChange:a=>_(t,a.target.checked),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),e.jsx("span",{className:"ml-2 text-sm text-gray-700",children:t})]}),e.jsx("button",{type:"button",onClick:a=>{a.preventDefault(),a.stopPropagation(),B(t)},className:"text-red-500 hover:text-red-700 p-1 rounded hover:bg-red-50 transition-colors",title:"Удалить категорию",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M6 18L18 6M6 6l12 12"})})})]},t))})]}),e.jsx("div",{className:"pt-2 border-t border-gray-200",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:C,onChange:t=>L(t.target.value),onKeyPress:t=>{t.key==="Enter"&&(t.preventDefault(),U())},placeholder:"Новая категория",className:"flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"}),e.jsx("button",{type:"button",onClick:U,disabled:!C.trim()||w,className:"px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600 disabled:bg-gray-300 disabled:cursor-not-allowed",children:w?"...":"Добавить"})]})})]})})]}),d.category&&e.jsx("p",{className:"mt-2 text-sm text-red-600",children:d.category})]}),e.jsxs("div",{className:"sm:col-span-3",children:[e.jsx("label",{htmlFor:"status",className:"block text-sm font-medium text-gray-700",children:"Статус *"}),e.jsx("div",{className:"mt-1",children:e.jsxs("select",{id:"status",name:"status",value:r.status,onChange:t=>n("status",t.target.value),className:"shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md",required:!0,children:[e.jsx("option",{value:"Черновик",children:"Черновик"}),e.jsx("option",{value:"Опубликовано",children:"Опубликовано"}),e.jsx("option",{value:"Запланировано",children:"Запланировано"})]})}),d.status&&e.jsx("p",{className:"mt-2 text-sm text-red-600",children:d.status})]}),e.jsxs("div",{className:"sm:col-span-3",children:[e.jsx("label",{htmlFor:"publishDate",className:"block text-sm font-medium text-gray-700",children:"Дата публикации"}),e.jsx("div",{className:"mt-1",children:e.jsx("input",{type:"date",name:"publishDate",id:"publishDate",value:r.publishDate,onChange:t=>n("publishDate",t.target.value),className:"shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md"})}),d.publishDate&&e.jsx("p",{className:"mt-2 text-sm text-red-600",children:d.publishDate})]}),e.jsxs("div",{className:"sm:col-span-6",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:["🎥 Медиа галерея",e.jsx("span",{className:"text-xs text-gray-500 ml-2",children:"- Добавьте изображения или видео (до 10 файлов)"})]}),e.jsx(Q,{media:x,setMedia:I,maxFiles:10}),e.jsx("div",{className:"mt-4",children:e.jsx(V,{onSelect:t=>{const a=[...x,t.path];I(a)},selectedMedia:x.map(t=>({path:t})),maxFiles:10})})]}),e.jsxs("div",{className:"sm:col-span-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Содержимое *"}),e.jsx(J,{value:r.content,onChange:$,placeholder:"Начните писать содержимое новости...",minHeight:"320px"}),d.content&&e.jsx("p",{className:"mt-2 text-sm text-red-600",children:d.content}),e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:"Минимум 10 символов"})]})]})}),e.jsx("div",{className:"px-4 py-3 bg-gray-50 text-right sm:px-6",children:e.jsx("button",{type:"submit",className:"inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-blue-300 disabled:cursor-not-allowed",disabled:E||A,children:E||A?"Сохранение...":N?"Сохранить изменения":"Создать новость"})})]})})]})}X.layout=s=>e.jsx(K,{title:"Редактирование новости",children:s});export{X as default};
