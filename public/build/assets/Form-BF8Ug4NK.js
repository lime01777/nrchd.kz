import{r as c,j as e,W as O,y as A,a as I}from"./app-C4SdFf0v.js";import{A as $}from"./AdminLayout-D7O3upuR.js";import{T as L,I as m}from"./TextInput-DH1H1fzM.js";import{I as x}from"./InputLabel-DWy2nEzG.js";import{P as B}from"./PrimaryButton-CpCr16oS.js";import{M as H}from"./ModernMediaUploader-CuRf_s4u.js";import{u as W,j as G,n as J,o as q,l as z}from"./index-Du4fhKCI.js";import"./transition-DRsP1kVM.js";import"./use-is-mounted-C9yZJA-W.js";function K({name:t="cover",label:S="Обложка",currentImageUrl:u=null,currentImageAlt:D=null,onImageChange:h=null,errors:s={}}){const[i,N]=c.useState(u),[d,_]=c.useState(!1),b=c.useRef(null),F=l=>{if(!["image/jpeg","image/jpg","image/png","image/webp"].includes(l.type)){alert("Недопустимый тип файла. Разрешены: JPG, PNG, WebP");return}const p=5*1024*1024;if(l.size>p){alert("Размер файла не должен превышать 5 МБ");return}const y=new Image;y.onload=()=>{if(y.width<800||y.height<400){alert("Минимальный размер изображения: 800×400 пикселей");return}const C=new FileReader;C.onload=P=>{N(P.target.result),h&&h(l)},C.readAsDataURL(l)},y.onerror=()=>{alert("Ошибка при загрузке изображения")},y.src=URL.createObjectURL(l)},v=()=>{var l;(l=b.current)==null||l.click()},k=l=>{var p;const f=(p=l.target.files)==null?void 0:p[0];f&&F(f)},j=l=>{l.preventDefault(),l.stopPropagation(),l.type==="dragenter"||l.type==="dragover"?_(!0):l.type==="dragleave"&&_(!1)},E=l=>{var p;l.preventDefault(),l.stopPropagation(),_(!1);const f=(p=l.dataTransfer.files)==null?void 0:p[0];f&&F(f)},r=()=>{N(null),b.current&&(b.current.value=""),h&&h(null)};return e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:S}),i&&e.jsxs("div",{className:"relative inline-block",children:[e.jsx("img",{src:i,alt:D||"Превью обложки",className:"max-w-full h-auto rounded-lg border border-gray-300 shadow-sm",style:{maxHeight:"400px"}}),e.jsx("button",{type:"button",onClick:r,className:"absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 transition-colors",title:"Удалить изображение",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsxs("div",{onClick:v,onDragEnter:j,onDragLeave:j,onDragOver:j,onDrop:E,className:`
                    border-2 border-dashed rounded-lg p-6 text-center cursor-pointer transition-colors
                    ${d?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-gray-400"}
                    ${i?"hidden":""}
                `,children:[e.jsx("input",{ref:b,type:"file",name:t,accept:"image/jpeg,image/jpg,image/png,image/webp",onChange:k,className:"hidden"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("svg",{className:"mx-auto h-12 w-12 text-gray-400",stroke:"currentColor",fill:"none",viewBox:"0 0 48 48",children:e.jsx("path",{d:"M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"})}),e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"font-semibold text-blue-600",children:"Нажмите для загрузки"})," или перетащите файл сюда"]}),e.jsx("div",{className:"text-xs text-gray-500",children:"JPG, PNG, WebP (макс. 5 МБ, мин. 800×400px)"})]})]}),s[t]&&e.jsx("p",{className:"text-sm text-red-600",children:s[t]})]})}function se({news:t=null,media:S=[]}){var R;const u=!!t,D=Array.isArray(t==null?void 0:t.media)?t.media:Array.isArray(S)?S:[],h=((R=document.querySelector('meta[name="csrf-token"]'))==null?void 0:R.getAttribute("content"))??"",{data:s,setData:i,processing:N,errors:d,reset:_}=O({title:(t==null?void 0:t.title)||"",slug:(t==null?void 0:t.slug)||"",excerpt:(t==null?void 0:t.excerpt)||"",body:(t==null?void 0:t.body)||"",cover:null,cover_image_alt:(t==null?void 0:t.cover_image_alt)||"",seo_title:(t==null?void 0:t.seo_title)||"",seo_description:(t==null?void 0:t.seo_description)||"",status:(t==null?void 0:t.status)||"draft",published_at:(t==null?void 0:t.published_at)||""}),[b,F]=c.useState(null),[v,k]=c.useState(D),[j,E]=c.useState(!1),r=W({extensions:[G.configure({bulletList:!0,orderedList:!0}),J.configure({inline:!1,allowBase64:!0}),q.configure({openOnClick:!1})],content:s.body,onUpdate:({editor:a})=>{i("body",a.getHTML())}});c.useEffect(()=>{r&&u&&(t!=null&&t.body)&&r.commands.setContent(t.body)},[r,u,t==null?void 0:t.body]),c.useEffect(()=>{k(D)},[t==null?void 0:t.id]);const l=()=>{const a=s.title.toLowerCase().replace(/[^-\uFFFF\w\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").trim();i("slug",a)},f=a=>{F(a),i("cover",a)},p=c.useCallback(a=>{!a||a.length===0||k(n=>{const g=a.map((o,M)=>({...o,position:o.position??n.length+M}));return[...n,...g]})},[]),y=c.useCallback(async a=>{const n=v.find(g=>g.id===a);if(k(g=>g.filter(o=>o.id!==a)),!(!h||!(n!=null&&n.path)))try{await fetch("/admin/news/media/temp",{method:"DELETE",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":h},body:JSON.stringify({path:n.path})})}catch(g){console.error("Ошибка удаления медиа файла",g)}},[v,h]),C=c.useCallback((a=null,n=null)=>{a&&a.preventDefault();const g=n??s.status;n&&i("status",n);const o=new FormData;o.append("title",s.title),o.append("slug",s.slug||""),o.append("excerpt",s.excerpt||""),o.append("body",r?r.getHTML():s.body),o.append("cover_image_alt",s.cover_image_alt||""),o.append("seo_title",s.seo_title||""),o.append("seo_description",s.seo_description||""),o.append("status",g),o.append("published_at",s.published_at||""),o.append("media",JSON.stringify(v||[])),b&&o.append("cover",b);const M=()=>{E(!1)},T=()=>{var U;u||(_(),F(null),k([]),(U=r==null?void 0:r.commands)==null||U.clearContent(!0))};u?(o.append("_method","PUT"),A.post(route("admin.news.update",t.id),o,{forceFormData:!0,onFinish:M,onSuccess:T})):A.post(route("admin.news.store"),o,{forceFormData:!0,onFinish:M,onSuccess:T})},[s,v,b,u,t==null?void 0:t.id,r,_,A]),P=c.useCallback(()=>{E(!0),C(null,"published")},[C]);return e.jsx($,{children:e.jsx("div",{className:"py-8",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:u?"Редактировать новость":"Создать новость"}),e.jsxs(I,{href:route("admin.news.index"),className:"mt-2 inline-flex items-center text-sm text-blue-600 hover:text-blue-800",children:[e.jsx("span",{className:"mr-2",children:"←"}),"Вернуться к списку"]})]}),e.jsxs("form",{onSubmit:a=>C(a),className:"space-y-6",children:[e.jsxs("div",{className:"bg-white shadow rounded-lg p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx(x,{htmlFor:"title",value:"Заголовок *"}),e.jsx(L,{id:"title",type:"text",value:s.title,onChange:a=>i("title",a.target.value),className:"mt-1 block w-full",required:!0}),e.jsx(m,{message:d.title,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{htmlFor:"slug",value:"URL-адрес (slug)"}),e.jsx("button",{type:"button",onClick:l,className:"text-sm text-blue-600 hover:text-blue-800",children:"Обновить из заголовка"})]}),e.jsx(L,{id:"slug",type:"text",value:s.slug,onChange:a=>i("slug",a.target.value),className:"mt-1 block w-full",placeholder:"Автоматически генерируется из заголовка"}),e.jsx(m,{message:d.slug,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"excerpt",value:"Краткое описание"}),e.jsx("textarea",{id:"excerpt",value:s.excerpt,onChange:a=>i("excerpt",a.target.value),className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",rows:3,placeholder:"Краткое описание новости для превью..."}),e.jsx(m,{message:d.excerpt,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"body",value:"Текст новости *"}),e.jsxs("div",{className:"mt-1 border border-gray-300 rounded-md",children:[r&&e.jsxs("div",{className:"border-b border-gray-200 p-2 flex flex-wrap gap-2",children:[e.jsx("button",{type:"button",onClick:()=>r.chain().focus().toggleBold().run(),className:`px-3 py-1 rounded text-sm ${r.isActive("bold")?"bg-gray-200 font-semibold":"hover:bg-gray-100"}`,children:"Жирный"}),e.jsx("button",{type:"button",onClick:()=>r.chain().focus().toggleItalic().run(),className:`px-3 py-1 rounded text-sm italic ${r.isActive("italic")?"bg-gray-200":"hover:bg-gray-100"}`,children:"Курсив"}),e.jsx("button",{type:"button",onClick:()=>r.chain().focus().toggleBulletList().run(),className:`px-3 py-1 rounded text-sm ${r.isActive("bulletList")?"bg-gray-200":"hover:bg-gray-100"}`,children:"Список"}),e.jsx("button",{type:"button",onClick:()=>r.chain().focus().setParagraph().run(),className:"px-3 py-1 rounded text-sm hover:bg-gray-100",children:"Абзац"})]}),e.jsx(z,{editor:r,className:"prose max-w-none p-4 min-h-[320px] focus:outline-none"})]}),e.jsx(m,{message:d.body,className:"mt-2"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsx(K,{name:"cover",label:"Обложка",currentImageUrl:t==null?void 0:t.cover_url,currentImageAlt:t==null?void 0:t.cover_image_alt,onImageChange:f,errors:d}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"cover_image_alt",value:"Альтернативный текст обложки (для SEO)"}),e.jsx(L,{id:"cover_image_alt",type:"text",value:s.cover_image_alt,onChange:a=>i("cover_image_alt",a.target.value),className:"mt-1 block w-full",placeholder:"Описание изображения для поисковых систем"}),e.jsx(m,{message:d.cover_image_alt,className:"mt-2"})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx(x,{htmlFor:"seo_title",value:"SEO заголовок"}),e.jsx(L,{id:"seo_title",type:"text",value:s.seo_title,onChange:a=>i("seo_title",a.target.value),className:"mt-1 block w-full",placeholder:"Если не указано — используется основной заголовок"}),e.jsx(m,{message:d.seo_title,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"seo_description",value:"SEO описание"}),e.jsx("textarea",{id:"seo_description",value:s.seo_description,onChange:a=>i("seo_description",a.target.value),className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",rows:2,placeholder:"Если не указано — используется краткое описание"}),e.jsx(m,{message:d.seo_description,className:"mt-2"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx(x,{htmlFor:"status",value:"Статус *"}),e.jsxs("select",{id:"status",value:s.status,onChange:a=>i("status",a.target.value),className:"mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500",required:!0,children:[e.jsx("option",{value:"draft",children:"Черновик"}),e.jsx("option",{value:"published",children:"Опубликовано"})]}),e.jsx(m,{message:d.status,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"published_at",value:"Дата и время публикации"}),e.jsx(L,{id:"published_at",type:"datetime-local",value:s.published_at,onChange:a=>i("published_at",a.target.value),className:"mt-1 block w-full"}),e.jsx(m,{message:d.published_at,className:"mt-2"})]})]})]}),e.jsxs("div",{className:"bg-white shadow rounded-lg p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-medium text-gray-900",children:"Галерея"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Загрузите дополнительные изображения или видео (поддерживаются форматы jpg, png, webp, mp4 и др.)."})]}),e.jsxs("span",{className:"text-sm text-gray-400",children:["Файлов: ",v.length]})]}),e.jsx(H,{existingMedia:v,onMediaUploaded:p,onMediaRemoved:y,maxFiles:30}),e.jsx(m,{message:d.media,className:"mt-2"})]}),e.jsxs("div",{className:"flex flex-wrap justify-end gap-4",children:[e.jsx(I,{href:route("admin.news.index"),className:"px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50",children:"Отмена"}),e.jsx(B,{type:"submit",disabled:N||j,className:"px-4 py-2",children:N?"Сохранение...":u?"Сохранить изменения":"Создать новость"}),!u&&e.jsx(B,{type:"button",disabled:N||j,onClick:P,className:"px-4 py-2 bg-green-600 hover:bg-green-700",children:j?"Публикация...":"Сохранить и опубликовать"})]})]})]})})})}export{se as default};
