import{r as d,j as e,a as G,W as Q,y as K,b as H}from"./app-B885_QiX.js";import{A as V}from"./AdminLayout-DATTFCH1.js";import{T as S,I as g}from"./TextInput-DfX30igR.js";import{I as f}from"./InputLabel-Bnd8n0jD.js";import{P as T}from"./PrimaryButton-BzeOiPsX.js";import{M as Y}from"./ModernMediaUploader-2didejVi.js";import{C as Z}from"./CategorySelector-C3-reuNP.js";import{u as w,j as ee,n as te,o as se,l as ae}from"./index-B30Katqz.js";import"./transition-DWb1ZgZz.js";import"./use-is-mounted-DQOA7NgG.js";function le({onMetadataParsed:t,onUrlChange:C,initialUrl:M=""}){const[j,A]=d.useState(M),[L,n]=d.useState(!1),[i,v]=d.useState(""),[u,N]=d.useState(null),k=async()=>{var x,l;if(!j||!j.trim()){v("Введите URL");return}try{new URL(j)}catch{v("Некорректный URL");return}n(!0),v(""),N(null);try{const a=await G.post("/admin/news/parse-url",{url:j.trim()});if(a.data.success){const F=a.data.data;N(F),t&&t(F)}else v(a.data.error||"Не удалось получить данные")}catch(a){console.error("Ошибка парсинга URL:",a),v(((l=(x=a.response)==null?void 0:x.data)==null?void 0:l.error)||"Ошибка при получении данных из ссылки")}finally{n(!1)}},c=x=>{x.key==="Enter"&&(x.preventDefault(),k())};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(f,{htmlFor:"external_url",value:"Ссылка на публикацию в СМИ"}),e.jsxs("div",{className:"mt-1 flex gap-2",children:[e.jsx(S,{id:"external_url",type:"url",value:j,onChange:x=>{const l=x.target.value;A(l),v(""),N(null),C&&C(l)},onKeyPress:c,className:"flex-1",placeholder:"https://example.com/article"}),e.jsx(T,{type:"button",onClick:k,disabled:L||!j.trim(),className:"whitespace-nowrap",children:L?"Загрузка...":"Получить данные"})]}),e.jsx(g,{message:i,className:"mt-2"})]}),u&&e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-4",children:[u.image&&e.jsx("img",{src:u.image,alt:u.title||"Превью",className:"w-24 h-24 object-cover rounded-lg flex-shrink-0",onError:x=>{x.target.style.display="none"}}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-semibold text-gray-900 truncate",children:u.title||"Без названия"}),u.description&&e.jsx("p",{className:"mt-1 text-sm text-gray-600 line-clamp-2",children:u.description}),e.jsx("p",{className:"mt-2 text-xs text-gray-500 truncate",children:u.url})]})]})})]})}function pe({news:t=null,media:C=[],section:M="news",sectionMeta:j=null,type:A="news",availableCategories:L=[]}){var I;const n=!!t,i=j||{},v=M||A||(t==null?void 0:t.type)||"news",u=d.useMemo(()=>Array.isArray(t==null?void 0:t.media)?t.media:Array.isArray(C)?C:[],[t==null?void 0:t.media,C]),N=d.useMemo(()=>Array.isArray(t==null?void 0:t.category)?t.category:[],[t==null?void 0:t.category]),k=((I=document.querySelector('meta[name="csrf-token"]'))==null?void 0:I.getAttribute("content"))??"",c=v,x=c==="news"?route("admin.news.index"):route("admin.news.index",c),{data:l,setData:a,processing:F,errors:p,reset:$}=Q({title:(t==null?void 0:t.title)||"",slug:(t==null?void 0:t.slug)||"",excerpt:(t==null?void 0:t.excerpt)||"",body:(t==null?void 0:t.body)||"",seo_title:(t==null?void 0:t.seo_title)||"",seo_description:(t==null?void 0:t.seo_description)||"",external_url:(t==null?void 0:t.external_url)||"",cover_image_path:(t==null?void 0:t.cover_image_path)||"",status:(t==null?void 0:t.status)||"draft",published_at:(t==null?void 0:t.published_at)||"",media:u,type:c,section:c,category:N}),[y,E]=d.useState(u),[P,D]=d.useState(!1),r=w({extensions:[ee.configure({bulletList:!0,orderedList:!0,link:!1}),te.configure({inline:!1,allowBase64:!0}),se.configure({openOnClick:!1})],content:l.body,onUpdate:({editor:s})=>{a("body",s.getHTML())}});d.useEffect(()=>{r&&n&&(t!=null&&t.body)&&r.commands.setContent(t.body)},[r,n,t==null?void 0:t.body]),d.useEffect(()=>{var s;n||(s=r==null?void 0:r.commands)==null||s.setContent(l.body||"")},[r]),d.useEffect(()=>{!n&&!(t!=null&&t.id)||(E(u),a("media",u),a("category",N))},[n,t==null?void 0:t.id,u,N]);const J=()=>{const s=l.title.toLowerCase().replace(/[^-\uFFFF\w\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").trim();a("slug",s)},W=d.useCallback(s=>{!s||s.length===0||E(o=>{const b=s.map((_,U)=>({..._,position:_.position??o.length+U})),m=[...o,...b];return a("media",m),m})},[a]),X=d.useCallback(async s=>{const o=y.find(b=>b.id===s);if(E(b=>{const m=b.filter(_=>_.id!==s);return a("media",m),m}),!(!k||!(o!=null&&o.path)||o!=null&&o.is_external||(o==null?void 0:o.source)==="external"))try{await fetch("/admin/news/media/temp",{method:"DELETE",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":k},body:JSON.stringify({path:o.path})})}catch(b){console.error("Ошибка удаления медиа файла",b)}},[y,k,a]),R=d.useCallback((s=null,o=null)=>{var O,B;s&&s.preventDefault();const b=o??l.status;a("status",b);const m={...l,status:b,media:y,body:r?r.getHTML():l.body,type:c,section:c,cover_image_path:l.cover_image_path||null,category:c==="media"?[]:l.category||[]};delete m.cover;const _=()=>{D(!1)},U=()=>{var h;n||($(),E([]),a("media",[]),a("category",[]),(h=r==null?void 0:r.commands)==null||h.clearContent(!0))};n?K.post(route("admin.news.update",{news:t.id}),{...m,_method:"PUT"},{forceFormData:!0,onFinish:_,onSuccess:U}):(console.log("Отправка формы создания новости (Form.jsx):",{title:m.title,body_length:((O=m.body)==null?void 0:O.length)||0,category_count:((B=m.category)==null?void 0:B.length)||0,status:m.status,media_count:y.length,type:m.type}),K.post(route("admin.news.store"),m,{forceFormData:!0,onFinish:_,onSuccess:U,onError:h=>{if(console.error("Ошибки валидации в Form.jsx:",h),h&&(Object.keys(h).forEach(q=>{console.error(`Ошибка в поле ${q}:`,h[q])}),h.error&&h.error.includes("419")||typeof h=="object"&&h.status===419)){alert("Сессия истекла. Страница будет обновлена."),window.location.reload();return}},onCancel:()=>{console.log("Запрос отменен")}}))},[l,y,n,t==null?void 0:t.id,r,$,a,c]),z=d.useCallback(()=>{D(!0),R(null,"published")},[R]);return e.jsx(V,{title:i==null?void 0:i.title,children:e.jsx("div",{className:"py-8",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:n?(i==null?void 0:i.editLabel)||"Редактировать новость":(i==null?void 0:i.createLabel)||"Создать новость"}),(i==null?void 0:i.subtitle)&&e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:i.subtitle}),e.jsxs(H,{href:x,className:"mt-2 inline-flex items-center text-sm text-blue-600 hover:text-blue-800",children:[e.jsx("span",{className:"mr-2",children:"←"}),(i==null?void 0:i.returnLabel)||"Вернуться к списку"]})]}),e.jsxs("form",{onSubmit:s=>R(s),className:"space-y-6",children:[c==="media"&&e.jsxs("div",{className:"bg-white shadow rounded-lg p-6",children:[e.jsx(le,{initialUrl:l.external_url,onUrlChange:s=>{a("external_url",s)},onMetadataParsed:s=>{if(s.title&&!l.title&&a("title",s.title),s.description&&!l.excerpt&&a("excerpt",s.description),s.description&&!l.body&&(a("body",`<p>${s.description}</p>`),r==null||r.commands.setContent(`<p>${s.description}</p>`)),s.image){const o={id:`external-${Date.now()}`,type:"image",path:s.image,url:s.image,name:s.title||"Изображение",is_external:!0,is_cover:!0};y.length>0?E([o,...y]):E([o]),a("cover_image_path",s.image)}a("external_url",s.url)}}),e.jsx(g,{message:p.external_url,className:"mt-2"})]}),e.jsxs("div",{className:"bg-white shadow rounded-lg p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx(f,{htmlFor:"title",value:"Заголовок *"}),e.jsx(S,{id:"title",type:"text",value:l.title,onChange:s=>a("title",s.target.value),className:"mt-1 block w-full",required:!0,placeholder:c==="media"?"Заголовок будет заполнен автоматически из ссылки":"Введите заголовок новости"}),e.jsx(g,{message:p.title,className:"mt-2"})]}),c!=="media"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(f,{htmlFor:"slug",value:"URL-адрес (slug)"}),e.jsx("button",{type:"button",onClick:J,className:"text-sm text-blue-600 hover:text-blue-800",children:"Обновить из заголовка"})]}),e.jsx(S,{id:"slug",type:"text",value:l.slug,onChange:s=>a("slug",s.target.value),className:"mt-1 block w-full",placeholder:"Автоматически генерируется из заголовка"}),e.jsx(g,{message:p.slug,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(f,{htmlFor:"excerpt",value:"Краткое описание"}),e.jsx("textarea",{id:"excerpt",value:l.excerpt,onChange:s=>a("excerpt",s.target.value),className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",rows:3,placeholder:"Краткое описание новости для превью..."}),e.jsx(g,{message:p.excerpt,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(f,{htmlFor:"body",value:"Текст новости *"}),e.jsxs("div",{className:"mt-1 border border-gray-300 rounded-md",children:[r&&e.jsxs("div",{className:"border-b border-gray-200 p-2 flex flex-wrap gap-2",children:[e.jsx("button",{type:"button",onClick:()=>r.chain().focus().toggleBold().run(),className:`px-3 py-1 rounded text-sm ${r.isActive("bold")?"bg-gray-200 font-semibold":"hover:bg-gray-100"}`,children:"Жирный"}),e.jsx("button",{type:"button",onClick:()=>r.chain().focus().toggleItalic().run(),className:`px-3 py-1 rounded text-sm italic ${r.isActive("italic")?"bg-gray-200":"hover:bg-gray-100"}`,children:"Курсив"}),e.jsx("button",{type:"button",onClick:()=>r.chain().focus().toggleBulletList().run(),className:`px-3 py-1 rounded text-sm ${r.isActive("bulletList")?"bg-gray-200":"hover:bg-gray-100"}`,children:"Список"}),e.jsx("button",{type:"button",onClick:()=>r.chain().focus().setParagraph().run(),className:"px-3 py-1 rounded text-sm hover:bg-gray-100",children:"Абзац"})]}),e.jsx(ae,{editor:r,className:"prose max-w-none p-4 min-h-[320px] focus:outline-none"})]}),e.jsx(g,{message:p.body,className:"mt-2"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx(f,{htmlFor:"seo_title",value:"SEO заголовок"}),e.jsx(S,{id:"seo_title",type:"text",value:l.seo_title,onChange:s=>a("seo_title",s.target.value),className:"mt-1 block w-full",placeholder:"Если не указано — используется основной заголовок"}),e.jsx(g,{message:p.seo_title,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(f,{htmlFor:"seo_description",value:"SEO описание"}),e.jsx("textarea",{id:"seo_description",value:l.seo_description,onChange:s=>a("seo_description",s.target.value),className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",rows:2,placeholder:"Если не указано — используется краткое описание"}),e.jsx(g,{message:p.seo_description,className:"mt-2"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx(f,{htmlFor:"status",value:c==="media"?"Статус":"Статус *"}),e.jsxs("select",{id:"status",value:l.status,onChange:s=>a("status",s.target.value),className:"mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500",required:c!=="media",children:[e.jsx("option",{value:"draft",children:"Черновик"}),e.jsx("option",{value:"published",children:"Опубликовано"})]}),e.jsx(g,{message:p.status,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(f,{htmlFor:"published_at",value:"Дата и время публикации"}),e.jsx(S,{id:"published_at",type:"datetime-local",value:l.published_at,onChange:s=>a("published_at",s.target.value),className:"mt-1 block w-full"}),e.jsx(g,{message:p.published_at,className:"mt-2"})]})]})]}),c!=="media"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-white shadow rounded-lg p-6",children:[e.jsx("h2",{className:"text-lg font-medium text-gray-900 mb-4",children:"Категории"}),L.length===0?e.jsx("p",{className:"text-sm text-gray-500",children:"Список категорий пуст. Обратитесь к администратору для настройки."}):e.jsx(Z,{selectedCategories:l.category,onCategoriesChange:s=>a("category",s),availableCategories:L,maxCategories:5}),e.jsx(g,{message:p.category,className:"mt-2"})]}),e.jsxs("div",{className:"bg-white shadow rounded-lg p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-medium text-gray-900",children:"Галерея"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Загрузите дополнительные изображения или видео (поддерживаются форматы jpg, png, webp, mp4 и др.)."})]}),e.jsxs("span",{className:"text-sm text-gray-400",children:["Файлов: ",y.length]})]}),e.jsx(Y,{existingMedia:y,onMediaUploaded:W,onMediaRemoved:X,maxFiles:30}),e.jsx(g,{message:p.media,className:"mt-2"})]})]}),e.jsxs("div",{className:"flex flex-wrap justify-end gap-4",children:[e.jsx(H,{href:x,className:"px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50",children:"Отмена"}),e.jsx(T,{type:"submit",disabled:F||P,className:"px-4 py-2",children:F?"Сохранение...":n?"Сохранить изменения":(i==null?void 0:i.createLabel)||"Создать запись"}),!n&&e.jsx(T,{type:"button",disabled:F||P,onClick:z,className:"px-4 py-2 bg-green-600 hover:bg-green-700",children:P?"Публикация...":"Сохранить и опубликовать"})]})]})]})})})}export{pe as default};
