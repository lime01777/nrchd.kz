import{r as y,W as q,j as t,a as G,y as H}from"./app-BdnHLJnp.js";import{A as K}from"./AdminLayout-DUm75zzB.js";import{M as P,a as Q,b as X}from"./MediaManager-BB9lhzFq.js";import"./transition-ByhlO8by.js";import"./use-is-mounted-DNgAPOUT.js";import"./SafeImage-Tm3jFLCw.js";import"./SafeVideo-BGDcS_QF.js";import"./mediaUtils-oRnee45q.js";const J=["Общие","Аккредитация","Обучение","Конференции","Методические материалы","Исследования","Анонсы"];function Y(){const[N,u]=y.useState(!1),{data:a,setData:d,post:D,processing:F,errors:m}=q({title:"",category:[],content:"",images:[],status:"Черновик",publishDate:new Date().toISOString().substr(0,10)}),[v,M]=y.useState(J),[h,j]=y.useState([]),[w,T]=y.useState(""),[_,z]=y.useState(!1),[C,E]=y.useState([]),S=o=>{console.log("Create - изменение медиа:",o),console.log("Create - типы элементов:",o.map(e=>{var f,p,x,s;return{type:typeof e,isFile:e instanceof File,hasFile:e&&e.file,name:(e==null?void 0:e.name)||((f=e==null?void 0:e.file)==null?void 0:f.name),mimeType:(e==null?void 0:e.type)||((p=e==null?void 0:e.file)==null?void 0:p.type),mediaType:(e==null?void 0:e.mediaType)||((x=e==null?void 0:e.file)==null?void 0:x.mediaType),size:(e==null?void 0:e.size)||((s=e==null?void 0:e.file)==null?void 0:s.size)}})),E(o);const n=[],r=[],i=[];o.forEach(e=>{var p,x,s;console.log("Обработка элемента медиа:",{item:e,type:typeof e,isFile:e instanceof File,hasFile:e&&e.file,name:(e==null?void 0:e.name)||((p=e==null?void 0:e.file)==null?void 0:p.name),mimeType:(e==null?void 0:e.type)||((x=e==null?void 0:e.file)==null?void 0:x.type),mediaType:(e==null?void 0:e.mediaType)||((s=e==null?void 0:e.file)==null?void 0:s.mediaType)});const f=l=>{var k;const c=l.name||"",g=l.type||"",b=((k=c.split(".").pop())==null?void 0:k.toLowerCase())||"";if(g.startsWith("video/"))return"video";if(g.startsWith("image/"))return"image";const R=["mp4","avi","mov","wmv","flv","webm"],U=["jpg","jpeg","png","gif","webp"];return R.includes(b)?"video":(U.includes(b)||console.warn("Неопределенный тип файла, считаем изображением:",c,g,b),"image")};if(e instanceof File)e.mediaType?e.mediaType==="video"?(console.log("Добавляем видео файл (по mediaType):",e.name),r.push(e)):(console.log("Добавляем изображение файл (по mediaType):",e.name),n.push(e)):f(e)==="video"?(console.log("Добавляем видео файл (по определению):",e.name),r.push(e)):(console.log("Добавляем изображение файл (по определению):",e.name),n.push(e));else if(e&&e.file){const l=e.file;l.mediaType?l.mediaType==="video"?(console.log("Добавляем видео файл из объекта (по mediaType):",l.name),r.push(l)):(console.log("Добавляем изображение файл из объекта (по mediaType):",l.name),n.push(l)):f(l)==="video"?(console.log("Добавляем видео файл из объекта (по определению):",l.name),r.push(l)):(console.log("Добавляем изображение файл из объекта (по определению):",l.name),n.push(l))}else typeof e=="string"?(console.log("Добавляем URL:",e),i.push(e)):e&&e.path?(console.log("Добавляем путь:",e.path),i.push(e.path)):console.warn("Неизвестный тип элемента:",e)}),console.log("Create - разделение файлов и URL:",{imageFiles:n,videoFiles:r,urls:i,totalFiles:n.length+r.length}),console.log("Create - устанавливаем данные в форму:",{urls:i,imageFiles:n.map(e=>({name:e.name,type:e.type,size:e.size})),videoFiles:r.map(e=>({name:e.name,type:e.type,size:e.size}))}),d("images",i),d("image_files",n),d("video_files",r)},L=v.map(o=>({value:o,label:o})),A=(o,n)=>{let r;n?r=[...h,o]:r=h.filter(i=>i!==o),j(r),d("category",r)},V=()=>{const o=v.map(n=>n);j(o),d("category",o)},B=()=>{j([]),d("category",[])},I=()=>{const o=v.filter(n=>!h.includes(n));j(o),d("category",o)},O=()=>{if(w&&!v.includes(w)){M([...v,w]);const o=[...h,w];j(o),d("category",o),T("")}};y.useEffect(()=>{const o=n=>{_&&!n.target.closest(".category-dropdown")&&z(!1)};return document.addEventListener("mousedown",o),()=>{document.removeEventListener("mousedown",o)}},[_]);const W=o=>{o.preventDefault(),u(!0);try{const n=a.category||[];if(!a.title||a.title.trim().length===0){alert("Заполните заголовок"),u(!1);return}if(typeof a.content!="string"&&d("content",String(a.content||"")),["Черновик","Опубликовано","Запланировано"].includes(a.status)||d("status","Черновик"),!a.content||a.content.replace(/<[^>]*?>/g,"").trim().length<10){alert("Содержимое должно содержать минимум 10 символов"),u(!1);return}if(n.length===0){alert("Выберите хотя бы одну категорию"),u(!1);return}console.log("Состояние медиа перед отправкой:",{media:C,data_images:a.images,data_image_files:a.image_files,data_video_files:a.video_files}),a.image_files&&a.image_files.length>0&&console.log("Детали файлов изображений:",a.image_files.map(s=>({name:s.name,type:s.type,size:s.size,sizeMB:(s.size/(1024*1024)).toFixed(2)+" MB",lastModified:s.lastModified,isValidSize:s.size<=10*1024*1024,isValidType:["image/jpeg","image/png","image/jpg","image/gif","image/webp"].includes(s.type)}))),a.video_files&&a.video_files.length>0&&console.log("Детали файлов видео:",a.video_files.map(s=>({name:s.name,type:s.type,size:s.size,sizeMB:(s.size/(1024*1024)).toFixed(2)+" MB",lastModified:s.lastModified,isValidSize:s.size<=50*1024*1024,isValidType:["video/mp4","video/avi","video/mov","video/wmv","video/flv","video/webm"].includes(s.type)})));const r={title:a.title,content:a.content,status:a.status,publishDate:a.publishDate||"",category:n,images:a.images||[]},i=[],e=[],f=s=>{var b;const l=s.name||"",c=s.type||"",g=((b=l.split(".").pop())==null?void 0:b.toLowerCase())||"";return c.startsWith("video/")||["mp4","avi","mov","wmv","flv","webm"].includes(g)?"video":c.startsWith("image/")||["jpg","jpeg","png","gif","webp"].includes(g)?"image":"unknown"};a.image_files&&a.image_files.length>0&&a.image_files.forEach(s=>{if(f(s)==="video"){console.warn("Видео файл попал в массив изображений, перемещаем:",s.name),e.push(s);return}const c=s.size<=10*1024*1024,g=["image/jpeg","image/png","image/jpg","image/gif","image/webp"].includes(s.type);c||console.warn("Файл изображения превышает размер:",s.name,(s.size/(1024*1024)).toFixed(2)+" MB"),g||console.warn("Неподдерживаемый тип файла изображения:",s.name,s.type),c&&g?i.push(s):alert(`Файл "${s.name}" не прошел валидацию:
${c?"":`- Размер превышает 10MB
`}${g?"":"- Неподдерживаемый тип файла"}`)}),a.video_files&&a.video_files.length>0&&a.video_files.forEach(s=>{if(f(s)==="image"){console.warn("Изображение попало в массив видео, перемещаем:",s.name),i.push(s);return}const c=s.size<=50*1024*1024,g=["video/mp4","video/avi","video/mov","video/wmv","video/flv","video/webm"].includes(s.type);c||console.warn("Файл видео превышает размер:",s.name,(s.size/(1024*1024)).toFixed(2)+" MB"),g||console.warn("Неподдерживаемый тип файла видео:",s.name,s.type),c&&g?e.push(s):alert(`Файл "${s.name}" не прошел валидацию:
${c?"":`- Размер превышает 50MB
`}${g?"":"- Неподдерживаемый тип файла"}`)}),i.length>0&&(r.image_files=i),e.length>0&&(r.video_files=e),i.length>0&&d("image_files",i),e.length>0&&d("video_files",e);const p=new FormData;p.append("title",a.title||""),p.append("content",a.content||""),p.append("status",a.status||"Черновик"),p.append("publishDate",a.publishDate||""),n&&n.length>0&&n.forEach(s=>{p.append("category[]",s)}),i.length>0&&i.forEach(s=>{p.append("image_files[]",s)}),e.length>0&&e.forEach(s=>{p.append("video_files[]",s)}),console.log("Отправка формы с данными:",{title:a.title,content_length:a.content?a.content.length:0,categories:n,images_count:a.images?a.images.length:0,image_files_count:a.image_files?a.image_files.length:0,video_files_count:a.video_files?a.video_files.length:0,validImageFiles_count:i.length,validVideoFiles_count:e.length,status:a.status}),console.log("ФИНАЛЬНЫЕ ДАННЫЕ ДЛЯ ОТПРАВКИ:",{submitData:r,validImageFiles:i.map(s=>({name:s.name,type:s.type,size:s.size})),validVideoFiles:e.map(s=>({name:s.name,type:s.type,size:s.size})),forceFormData:i.length>0||e.length>0});const x={preserveScroll:!0,forceFormData:i.length>0||e.length>0,onSuccess:s=>{console.log("Успешное сохранение:",s),u(!1)},onError:s=>{console.error("Ошибки валидации:",s),u(!1);const l=[];Object.keys(s).forEach(c=>{Array.isArray(s[c])?l.push(...s[c]):l.push(s[c])}),l.length>0&&alert(`Ошибки валидации:
`+l.join(`
`))},onFinish:()=>{u(!1)}};console.log("ОТПРАВКА ФОРМЫ:",{route:route("admin.news.store"),submitData:r,options:x,forceFormData:i.length>0||e.length>0}),i.length>0||e.length>0?fetch(route("admin.news.store"),{method:"POST",body:p,headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),Accept:"application/json"}}).then(s=>s.json()).then(s=>{console.log("Результат отправки:",s),s.success?H.visit(route("admin.news")):(console.error("Ошибка при сохранении:",s),alert("Ошибка при сохранении новости")),u(!1)}).catch(s=>{console.error("Ошибка при отправке:",s),alert("Ошибка при отправке формы"),u(!1)}):D(route("admin.news.store"),a,x)}catch(n){console.error("Ошибка при отправке формы:",n),u(!1)}},$=o=>{d("content",o)};return t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"mb-6 flex items-center justify-between",children:[t.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Создание новости"}),t.jsxs(G,{href:route("admin.news"),className:"inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:[t.jsx("svg",{className:"h-5 w-5 mr-2",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M10 19l-7-7m0 0l7-7m-7 7h18"})}),"Назад к списку"]})]}),t.jsx("div",{className:"bg-white shadow overflow-hidden sm:rounded-lg",children:t.jsxs("form",{onSubmit:W,className:"min-h-full",children:[t.jsx("div",{className:"px-4 py-5 sm:p-6",children:t.jsxs("div",{className:"grid grid-cols-1 gap-6 sm:grid-cols-6",children:[t.jsxs("div",{className:"sm:col-span-6",children:[t.jsx("label",{htmlFor:"title",className:"block text-sm font-medium text-gray-700",children:"Заголовок *"}),t.jsx("div",{className:"mt-1",children:t.jsx("input",{type:"text",name:"title",id:"title",value:a.title,onChange:o=>d("title",o.target.value),className:"shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md",required:!0,placeholder:"Введите заголовок новости"})}),m.title&&t.jsx("p",{className:"mt-2 text-sm text-red-600",children:m.title})]}),t.jsxs("div",{className:"sm:col-span-6",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Категории *"}),t.jsxs("div",{className:"relative category-dropdown",children:[t.jsxs("button",{type:"button",onClick:()=>z(!_),className:"w-full flex items-center justify-between px-3 py-2 border border-gray-300 rounded-md bg-white text-left text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[t.jsx("span",{className:h.length>0?"text-gray-900":"text-gray-500",children:h.length>0?`Выбрано: ${h.length} категорий`:"Выберите категории..."}),t.jsx("svg",{className:"w-5 h-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 9l-7 7-7-7"})})]}),_&&t.jsx("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto",children:t.jsxs("div",{className:"p-2",children:[t.jsxs("div",{className:"flex gap-2 mb-3 pb-2 border-b border-gray-200",children:[t.jsx("button",{type:"button",onClick:V,className:"px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600",children:"Выбрать все"}),t.jsx("button",{type:"button",onClick:B,className:"px-2 py-1 text-xs bg-gray-600 text-white rounded hover:bg-gray-700",children:"Снять выбор"}),t.jsx("button",{type:"button",onClick:I,className:"px-2 py-1 text-xs bg-purple-500 text-white rounded hover:bg-purple-600",children:"Инвертировать"})]}),t.jsx("div",{className:"space-y-1",children:L.map(o=>t.jsxs("label",{className:"flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:h.includes(o.value),onChange:n=>A(o.value,n.target.checked),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),t.jsx("span",{className:"ml-2 text-sm text-gray-700",children:o.label})]},o.value))}),t.jsx("div",{className:"mt-3 pt-2 border-t border-gray-200",children:t.jsxs("div",{className:"flex gap-2",children:[t.jsx("input",{type:"text",value:w,onChange:o=>T(o.target.value),placeholder:"Новая категория",className:"flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"}),t.jsx("button",{type:"button",onClick:O,className:"px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600",children:"Добавить"})]})})]})})]}),m.category&&t.jsx("p",{className:"mt-2 text-sm text-red-600",children:m.category})]}),t.jsxs("div",{className:"sm:col-span-3",children:[t.jsx("label",{htmlFor:"status",className:"block text-sm font-medium text-gray-700",children:"Статус *"}),t.jsx("div",{className:"mt-1",children:t.jsxs("select",{id:"status",name:"status",value:a.status,onChange:o=>d("status",o.target.value),className:"shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md",required:!0,children:[t.jsx("option",{value:"Черновик",children:"Черновик"}),t.jsx("option",{value:"Опубликовано",children:"Опубликовано"}),t.jsx("option",{value:"Запланировано",children:"Запланировано"})]})}),m.status&&t.jsx("p",{className:"mt-2 text-sm text-red-600",children:m.status})]}),t.jsxs("div",{className:"sm:col-span-3",children:[t.jsx("label",{htmlFor:"publishDate",className:"block text-sm font-medium text-gray-700",children:"Дата публикации"}),t.jsx("div",{className:"mt-1",children:t.jsx("input",{type:"date",name:"publishDate",id:"publishDate",value:a.publishDate,onChange:o=>d("publishDate",o.target.value),className:"shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md"})}),m.publishDate&&t.jsx("p",{className:"mt-2 text-sm text-red-600",children:m.publishDate})]}),t.jsxs("div",{className:"sm:col-span-6",children:[t.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:["🎥 Медиа галерея",t.jsx("span",{className:"text-xs text-gray-500 ml-2",children:"- Добавьте изображения или видео (до 10 файлов)"})]}),t.jsx(P,{media:C,setMedia:S,maxFiles:10}),t.jsx("div",{className:"mt-4",children:t.jsx(Q,{onSelect:o=>{const n=[...C,o];S(n)},selectedMedia:C,maxFiles:10})})]}),t.jsxs("div",{className:"sm:col-span-6",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Содержимое *"}),t.jsx(X,{value:a.content,onChange:$,placeholder:"Начните писать содержимое новости...",minHeight:"320px"}),m.content&&t.jsx("p",{className:"mt-2 text-sm text-red-600",children:m.content}),t.jsx("p",{className:"mt-1 text-xs text-gray-500",children:"Минимум 10 символов"})]})]})}),t.jsx("div",{className:"px-4 py-3 bg-gray-50 text-right sm:px-6",children:t.jsx("button",{type:"submit",className:"inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",disabled:F||N,children:F||N?"Создание...":"Создать новость"})})]})})]})}Y.layout=N=>t.jsx(K,{title:"Создание новости",children:N});export{Y as default};
