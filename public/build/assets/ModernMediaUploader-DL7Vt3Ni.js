import{r as m,j as t}from"./app-CZOK16ls.js";function L({existingMedia:n=[],onMediaUploaded:p,onMediaRemoved:w,maxFiles:c=20,className:U=""}){const[S,j]=m.useState(!1),[x,N]=m.useState(""),[y,g]=m.useState(""),$=()=>typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`external-${Date.now()}-${Math.random().toString(16).slice(2)}`,k=m.useCallback(e=>{if(!e||typeof e!="string")return{error:"Укажите ссылку на внешний ресурс"};const i=e.trim();let a;try{a=new URL(i)}catch{return{error:"Некорректная ссылка. Проверьте адрес."}}const r=a.toString(),l=r.toLowerCase(),o=r.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|shorts\/))([\w-]{6,})/i);if(o){const s=o[1];return{type:"video",provider:"youtube",url:r,embedUrl:`https://www.youtube.com/embed/${s}`,thumbnail:`https://img.youtube.com/vi/${s}/hqdefault.jpg`,name:"YouTube видео"}}const u=r.match(/instagram\.com\/(p|reel|tv)\/([^/?&]+)/i);if(u){const s=u[1],d=u[2];return{type:"video",provider:"instagram",url:r,embedUrl:`https://www.instagram.com/${s}/${d}/embed/`,name:"Instagram видео"}}return l.includes("aitube.kz")||l.includes("aitube.com")||l.includes("aitu.kz")?{type:"video",provider:"aitube",url:r,embedUrl:r,name:"Aitu видео"}:l.match(/\.(jpg|jpeg|png|gif|webp|avif)(\?|$)/)?{type:"image",provider:"external",url:r,embedUrl:null,name:"Внешнее изображение"}:{type:"video",provider:"external",url:r,embedUrl:r,name:"Внешнее видео"}},[]),C=m.useCallback(async e=>{var l;const i=Array.from(e.target.files);if(i.length===0)return;const a=Math.max(0,c-n.length);if(a<=0){alert(`Достигнут лимит файлов (${c}). Удалите лишние медиа, чтобы загрузить новые.`),e.target.value="";return}const r=i.slice(0,a);if(r.length===0){e.target.value="";return}j(!0);try{const o=new FormData;r.forEach((h,b)=>{o.append(`media_files[${b}]`,h)});const u=(l=document.querySelector('meta[name="csrf-token"]'))==null?void 0:l.getAttribute("content");if(!u)throw new Error("CSRF токен не найден. Пожалуйста, обновите страницу.");const s=await fetch("/admin/news/upload-media",{method:"POST",body:o,headers:{"X-CSRF-TOKEN":u,"X-Requested-With":"XMLHttpRequest",Accept:"application/json"},credentials:"include"});if(!s.ok){if(s.status===419){const b=await s.text();throw new Error("Сессия истекла. Пожалуйста, обновите страницу и попробуйте снова.")}let h="Ошибка загрузки файлов";try{const b=await s.json();h=b.message||b.error||h}catch{h=`Ошибка ${s.status}: ${s.statusText}`}throw new Error(h)}const d=await s.json();p&&d.success&&d.media&&p(d.media)}catch(o){console.error("Ошибка загрузки медиа:",o),alert("Ошибка загрузки файлов: "+o.message)}finally{j(!1),e.target.value=""}},[n.length,c,p]),v=m.useCallback(()=>{if(n.length>=c){g(`Достигнут лимит файлов (${c}). Удалите лишние медиа, чтобы добавить новые ссылки.`);return}const e=k(x);if(e.error){g(e.error);return}const i={id:$(),type:e.type==="image"?"image":"video",path:e.url,url:e.url,embed_url:e.embedUrl,provider:e.provider,source:"external",is_external:!0,is_embed:!!(e.embedUrl&&e.embedUrl!==e.url),name:e.name||"Внешний ресурс",position:n.length,thumbnail:e.thumbnail||null};p&&p([i]),N(""),g("")},[k,n.length,x,c,p]),D=m.useCallback(e=>{e.key==="Enter"&&(e.preventDefault(),v())},[v]),E=Math.max(0,c-n.length),f=S||E<=0,_=e=>{w&&w(e)};return t.jsxs("div",{className:U,children:[t.jsxs("div",{className:`border-2 border-dashed rounded-lg p-6 text-center transition-colors ${f?"cursor-not-allowed opacity-60 border-gray-200":"cursor-pointer border-gray-300 hover:border-gray-400"}`,children:[t.jsx("input",{type:"file",multiple:!0,accept:"image/*,video/*",onChange:C,className:"hidden",id:"media-upload",disabled:f}),t.jsxs("label",{htmlFor:"media-upload",className:f?"cursor-not-allowed":"cursor-pointer",children:[t.jsx("svg",{className:"mx-auto h-12 w-12 text-gray-400",stroke:"currentColor",fill:"none",viewBox:"0 0 48 48",children:t.jsx("path",{d:"M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})}),t.jsxs("div",{className:"mt-4",children:[t.jsx("p",{className:"text-sm text-gray-600",children:"Нажмите для выбора файлов"}),t.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Поддерживаются изображения и видео до 50MB"}),t.jsxs("p",{className:"mt-2 text-xs text-gray-400",children:["Осталось ",E," из ",c," файлов"]})]})]})]}),t.jsxs("div",{className:"mt-3 rounded-lg border border-gray-200 bg-gray-50 p-4",children:[t.jsx("p",{className:"text-sm text-gray-600",children:"Или вставьте ссылку на внешнее видео: поддерживаются YouTube, Instagram, Aitube и прямые ссылки на файлы."}),t.jsxs("div",{className:"mt-3 flex flex-col gap-2 sm:flex-row",children:[t.jsx("input",{type:"url",value:x,onChange:e=>{N(e.target.value),y&&g("")},onKeyDown:D,placeholder:"https://www.youtube.com/watch?v=...",className:"flex-1 rounded-md border border-gray-300 px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200"}),t.jsx("button",{type:"button",onClick:v,disabled:f||x.trim()==="",className:"inline-flex items-center justify-center rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-blue-700 disabled:cursor-not-allowed disabled:opacity-60",children:"Добавить ссылку"})]}),y&&t.jsx("p",{className:"mt-2 text-xs text-red-500",children:y})]}),n.length>0&&t.jsxs("div",{className:"mt-4",children:[t.jsx("h4",{className:"text-sm font-medium text-gray-700 mb-3",children:"Загруженные файлы:"}),t.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3",children:n.map((e,i)=>{const a=e.name||e.provider||"Медиа",r=e.embed_url||e.url||e.path,l=e.url||e.path,o=e.thumbnail||(e.type==="image"?r:null),u=!!e.is_external,s=!!(e.is_embed&&e.embed_url),d=e.provider?e.provider.toUpperCase():null;return t.jsxs("div",{className:"relative group",children:[t.jsx("div",{className:"aspect-square bg-gray-100 rounded-lg overflow-hidden",children:e.type==="video"?s?t.jsx("iframe",{src:e.embed_url||r,title:a,className:"h-full w-full",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share",allowFullScreen:!0}):t.jsx("video",{src:r,poster:o||void 0,className:"w-full h-full object-cover",muted:!0,controls:!0}):t.jsx("img",{src:o||l,alt:a,className:"w-full h-full object-cover"})}),d&&t.jsx("span",{className:"absolute left-1.5 top-1.5 rounded bg-black/60 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-white",children:d}),u&&!s&&e.type==="video"&&t.jsx("span",{className:"absolute left-1.5 bottom-1.5 rounded bg-blue-600 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-white",children:"Ссылка"}),e.isUploading&&t.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center",children:t.jsx("div",{className:"text-white text-sm",children:"Загрузка..."})}),t.jsx("button",{type:"button",onClick:()=>_(e.id),className:"absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity",children:"×"}),t.jsx("div",{className:"mt-1 text-xs text-gray-600 truncate",children:a})]},e.id||`media-${i}`)})})]})]})}export{L as M};
