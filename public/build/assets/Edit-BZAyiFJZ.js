import{r as m,W as G,j as s,a as H}from"./app-C_HHkXdl.js";import{A as K}from"./AdminLayout-cJR3Sr8P.js";import{M as Q,a as J,b as V}from"./MediaManager-CWSQpvEG.js";import"./transition-BVf4Sxmg.js";import"./use-is-mounted-DwQTC4gx.js";import"./SafeImage-Cg856OXM.js";import"./SafeVideo-DdQmqMnV.js";import"./mediaUtils-oRnee45q.js";const N=["Общие","Аккредитация","Обучение","Конференции","Методические материалы","Исследования","Филиалы","Анонсы событий"];function X({news:a=null}){const E=!!a,[S,b]=m.useState(!1),{data:r,setData:d,post:_,put:U,processing:A,errors:p}=G({title:(a==null?void 0:a.title)||"",category:Array.isArray(a==null?void 0:a.category)?a.category:a!=null&&a.category?[a.category]:[],content:typeof(a==null?void 0:a.content)=="string"?a.content:"",images:(a==null?void 0:a.images)||[],status:(a==null?void 0:a.status)||"Черновик",publishDate:(a==null?void 0:a.publishDate)||new Date().toISOString().substr(0,10)});m.useEffect(()=>{a&&console.log("Загруженные данные новости:",{title:a.title,images:a.images,main_image:a.main_image})},[a]);const[f,D]=m.useState(()=>{if(a!=null&&a.category){const t=Array.isArray(a.category)?a.category:[a.category];return Array.from(new Set([...N,...t]))}return N}),[h,v]=m.useState(Array.isArray(r.category)?r.category:r.category?[r.category]:[]),[k,T]=m.useState(""),[C,L]=m.useState(!1),[y,w]=m.useState(r.images||[]),[M,Y]=m.useState(!1);console.log("NewsEdit - данные новости:",{news:a,data:r,images:r.images,imagesType:typeof r.images}),m.useEffect(()=>{r.images&&r.images.length>0&&w(r.images)},[]),m.useEffect(()=>{const t=o=>{C&&!o.target.closest(".category-dropdown")&&L(!1)};return document.addEventListener("mousedown",t),()=>{document.removeEventListener("mousedown",t)}},[C]);const z=t=>{console.log("Edit - изменение медиа:",t),console.log("Edit - типы элементов:",t.map(e=>{var u,g,l,n;return{type:typeof e,isFile:e instanceof File,hasFile:e&&e.file,name:(e==null?void 0:e.name)||((u=e==null?void 0:e.file)==null?void 0:u.name),mimeType:(e==null?void 0:e.type)||((g=e==null?void 0:e.file)==null?void 0:g.type),mediaType:(e==null?void 0:e.mediaType)||((l=e==null?void 0:e.file)==null?void 0:l.mediaType),size:(e==null?void 0:e.size)||((n=e==null?void 0:e.file)==null?void 0:n.size)}})),w(t);const o=[],i=[],c=[],x=e=>{var F;const u=e.name||"",g=e.type||"",l=((F=u.split(".").pop())==null?void 0:F.toLowerCase())||"";if(g.startsWith("video/"))return"video";if(g.startsWith("image/"))return"image";const n=["mp4","avi","mov","wmv","flv","webm"],j=["jpg","jpeg","png","gif","webp"];return n.includes(l)?"video":(j.includes(l)||console.warn("Неопределенный тип файла, считаем изображением:",u,g,l),"image")};t.forEach(e=>{var u,g,l;if(console.log("Edit - обработка элемента медиа:",{item:e,type:typeof e,isFile:e instanceof File,hasFile:e&&e.file,name:(e==null?void 0:e.name)||((u=e==null?void 0:e.file)==null?void 0:u.name),mimeType:(e==null?void 0:e.type)||((g=e==null?void 0:e.file)==null?void 0:g.type),mediaType:(e==null?void 0:e.mediaType)||((l=e==null?void 0:e.file)==null?void 0:l.mediaType)}),e instanceof File)e.mediaType?e.mediaType==="video"?(console.log("Edit - добавляем видео файл (по mediaType):",e.name),i.push(e)):(console.log("Edit - добавляем изображение файл (по mediaType):",e.name),o.push(e)):x(e)==="video"?(console.log("Edit - добавляем видео файл (по определению):",e.name),i.push(e)):(console.log("Edit - добавляем изображение файл (по определению):",e.name),o.push(e));else if(e&&e.file){const n=e.file;n.mediaType?n.mediaType==="video"?(console.log("Edit - добавляем видео файл из объекта (по mediaType):",n.name),i.push(n)):(console.log("Edit - добавляем изображение файл из объекта (по mediaType):",n.name),o.push(n)):x(n)==="video"?(console.log("Edit - добавляем видео файл из объекта (по определению):",n.name),i.push(n)):(console.log("Edit - добавляем изображение файл из объекта (по определению):",n.name),o.push(n))}else typeof e=="string"?(console.log("Edit - добавляем URL:",e),c.push(e)):e&&e.path?(console.log("Edit - добавляем путь:",e.path),c.push(e.path)):console.warn("Edit - неизвестный тип элемента:",e)}),console.log("Edit - разделение файлов и URL:",{imageFiles:o,videoFiles:i,urls:c,totalFiles:o.length+i.length}),console.log("Edit - устанавливаем данные в форму:",{urls:c,imageFiles:o.map(e=>({name:e.name,type:e.type,size:e.size})),videoFiles:i.map(e=>({name:e.name,type:e.type,size:e.size}))}),d("images",c),d("image_files",o),d("video_files",i)},I=(t,o)=>{let i;o?i=[...h,t]:i=h.filter(c=>c!==t),v(i),d("category",i)},W=()=>{const t=k.trim();if(!t){alert("Введите название категории");return}if(f.includes(t)){alert("Такая категория уже существует");return}if(t.length<2){alert("Название категории должно содержать минимум 2 символа");return}if(t.length>50){alert("Название категории не должно превышать 50 символов");return}const o=[...f,t];D(o);const i=[...h,t];v(i),d("category",i),T("")},O=t=>{if(!confirm(`Вы уверены, что хотите удалить категорию "${t}"?`))return;const o=h.filter(c=>c!==t);v(o),d("category",o);const i=f.filter(c=>c!==t);D(i)},R=()=>{v([...f]),d("category",[...f])},B=()=>{v([]),d("category",[])},q=()=>{const t=f.filter(o=>!h.includes(o));v(t),d("category",t)},P=t=>{t.preventDefault(),b(!0);try{const o=r.category||[];if(console.log("Изображения перед отправкой:",{images:y,data_images:r.images}),!r.title||r.title.trim().length===0){alert("Заполните заголовок"),b(!1);return}if(Array.isArray(r.category)||d("category",typeof r.category=="string"?[r.category]:[]),typeof r.content!="string"&&d("content",String(r.content||"")),["Черновик","Опубликовано","Запланировано"].includes(r.status)||d("status","Черновик"),!r.content||r.content.replace(/<[^>]*?>/g,"").trim().length<10){alert("Содержимое должно содержать минимум 10 символов"),b(!1);return}if(o.length===0){alert("Выберите хотя бы одну категорию"),b(!1);return}console.log("Состояние изображений перед отправкой:",{images:y,imagesLength:y?y.length:0});const i=Array.isArray(y)?y.filter(l=>l&&(typeof l=="string"||l instanceof File&&l.size>0)):[];console.log("Валидные изображения:",i);const c=[],x=[],e=[];i.forEach(l=>{var n;if(l instanceof File)if(l.type.startsWith("video/"))x.push(l);else if(l.type.startsWith("image/"))c.push(l);else{const j=(n=l.name.split(".").pop())==null?void 0:n.toLowerCase();["mp4","avi","mov","wmv","flv","webm"].includes(j)?x.push(l):c.push(l)}else typeof l=="string"&&l.trim()&&e.push(l)}),console.log("Разделение файлов и URL:",{imageFiles:c,videoFiles:x,urls:e,totalFiles:c.length+x.length});const u={title:r.title,content:r.content,status:r.status,publishDate:r.publishDate||"",category:o,images:e};c.length>0&&(u.image_files=c),x.length>0&&(u.video_files=x),console.log("Финальные данные для отправки:",u);const g={preserveScroll:!0,forceFormData:c.length>0||x.length>0,onSuccess:l=>{console.log("Успешное сохранение:",l),b(!1)},onError:l=>{console.error("Ошибки валидации:",l),b(!1);const n=[];Object.keys(l).forEach(j=>{Array.isArray(l[j])?n.push(...l[j]):n.push(l[j])}),n.length>0&&alert(`Ошибки валидации:
`+n.join(`
`))},onFinish:()=>{b(!1)}};E?U(route("admin.news.update",a.id),u,g):_(route("admin.news.store"),u,g)}catch(o){console.error("Ошибка при отправке формы:",o),b(!1),alert("Произошла ошибка при отправке формы")}},$=t=>{d("content",t)};return s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"mb-6 flex items-center justify-between",children:[s.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:E?"Редактирование новости":"Создание новости"}),s.jsxs(H,{href:route("admin.news"),className:"inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:[s.jsx("svg",{className:"h-5 w-5 mr-2",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M10 19l-7-7m0 0l7-7m-7 7h18"})}),"Назад к списку"]})]}),s.jsx("div",{className:"bg-white shadow overflow-hidden sm:rounded-lg",children:s.jsxs("form",{onSubmit:P,className:"min-h-full",children:[s.jsx("div",{className:"px-4 py-5 sm:p-6",children:s.jsxs("div",{className:"grid grid-cols-1 gap-6 sm:grid-cols-6",children:[s.jsxs("div",{className:"sm:col-span-6",children:[s.jsx("label",{htmlFor:"title",className:"block text-sm font-medium text-gray-700",children:"Заголовок *"}),s.jsx("div",{className:"mt-1",children:s.jsx("input",{type:"text",name:"title",id:"title",value:r.title,onChange:t=>d("title",t.target.value),className:"shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md",required:!0,placeholder:"Введите заголовок новости"})}),p.title&&s.jsx("p",{className:"mt-2 text-sm text-red-600",children:p.title})]}),s.jsxs("div",{className:"sm:col-span-6",children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Категории *"}),s.jsxs("div",{className:"relative category-dropdown",children:[s.jsxs("button",{type:"button",onClick:()=>L(!C),className:"w-full flex items-center justify-between px-3 py-2 border border-gray-300 rounded-md bg-white text-left text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[s.jsx("span",{className:h.length>0?"text-gray-900":"text-gray-500",children:h.length>0?`Выбрано: ${h.length} категорий`:"Выберите категории..."}),s.jsx("svg",{className:"w-5 h-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 9l-7 7-7-7"})})]}),C&&s.jsx("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto",children:s.jsxs("div",{className:"p-2",children:[s.jsxs("div",{className:"flex gap-2 mb-3 pb-2 border-b border-gray-200",children:[s.jsx("button",{type:"button",onClick:R,className:"px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600",children:"Выбрать все"}),s.jsx("button",{type:"button",onClick:B,className:"px-2 py-1 text-xs bg-gray-600 text-white rounded hover:bg-gray-700",children:"Снять выбор"}),s.jsx("button",{type:"button",onClick:q,className:"px-2 py-1 text-xs bg-purple-500 text-white rounded hover:bg-purple-600",children:"Инвертировать"})]}),s.jsxs("div",{className:"mb-3",children:[s.jsx("h5",{className:"text-xs font-medium text-gray-600 mb-2 uppercase tracking-wide",children:"Стандартные категории"}),s.jsx("div",{className:"space-y-1",children:f.filter(t=>N.includes(t)).map(t=>s.jsxs("label",{className:"flex items-center justify-between p-2 hover:bg-gray-50 rounded cursor-pointer",children:[s.jsxs("div",{className:"flex items-center",children:[s.jsx("input",{type:"checkbox",checked:h.includes(t),onChange:o=>I(t,o.target.checked),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),s.jsx("span",{className:"ml-2 text-sm text-gray-700",children:t})]}),s.jsx("span",{className:"text-xs text-gray-400 px-2 py-1 bg-gray-100 rounded",children:"Стандартная"})]},t))})]}),f.filter(t=>!N.includes(t)).length>0&&s.jsxs("div",{className:"mb-3",children:[s.jsx("h5",{className:"text-xs font-medium text-gray-600 mb-2 uppercase tracking-wide",children:"Пользовательские категории"}),s.jsx("div",{className:"space-y-1",children:f.filter(t=>!N.includes(t)).map(t=>s.jsxs("label",{className:"flex items-center justify-between p-2 hover:bg-gray-50 rounded cursor-pointer",children:[s.jsxs("div",{className:"flex items-center",children:[s.jsx("input",{type:"checkbox",checked:h.includes(t),onChange:o=>I(t,o.target.checked),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),s.jsx("span",{className:"ml-2 text-sm text-gray-700",children:t})]}),s.jsx("button",{type:"button",onClick:o=>{o.preventDefault(),o.stopPropagation(),O(t)},className:"text-red-500 hover:text-red-700 p-1 rounded hover:bg-red-50 transition-colors",title:"Удалить категорию",children:s.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M6 18L18 6M6 6l12 12"})})})]},t))})]}),s.jsx("div",{className:"pt-2 border-t border-gray-200",children:s.jsxs("div",{className:"flex gap-2",children:[s.jsx("input",{type:"text",value:k,onChange:t=>T(t.target.value),onKeyPress:t=>{t.key==="Enter"&&(t.preventDefault(),W())},placeholder:"Новая категория",className:"flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"}),s.jsx("button",{type:"button",onClick:W,disabled:!k.trim()||M,className:"px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600 disabled:bg-gray-300 disabled:cursor-not-allowed",children:M?"...":"Добавить"})]})})]})})]}),p.category&&s.jsx("p",{className:"mt-2 text-sm text-red-600",children:p.category})]}),s.jsxs("div",{className:"sm:col-span-3",children:[s.jsx("label",{htmlFor:"status",className:"block text-sm font-medium text-gray-700",children:"Статус *"}),s.jsx("div",{className:"mt-1",children:s.jsxs("select",{id:"status",name:"status",value:r.status,onChange:t=>d("status",t.target.value),className:"shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md",required:!0,children:[s.jsx("option",{value:"Черновик",children:"Черновик"}),s.jsx("option",{value:"Опубликовано",children:"Опубликовано"}),s.jsx("option",{value:"Запланировано",children:"Запланировано"})]})}),p.status&&s.jsx("p",{className:"mt-2 text-sm text-red-600",children:p.status})]}),s.jsxs("div",{className:"sm:col-span-3",children:[s.jsx("label",{htmlFor:"publishDate",className:"block text-sm font-medium text-gray-700",children:"Дата публикации"}),s.jsx("div",{className:"mt-1",children:s.jsx("input",{type:"date",name:"publishDate",id:"publishDate",value:r.publishDate,onChange:t=>d("publishDate",t.target.value),className:"shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md"})}),p.publishDate&&s.jsx("p",{className:"mt-2 text-sm text-red-600",children:p.publishDate})]}),s.jsxs("div",{className:"sm:col-span-6",children:[s.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:["🎥 Медиа галерея",s.jsx("span",{className:"text-xs text-gray-500 ml-2",children:"- Добавьте изображения или видео (до 10 файлов)"})]}),s.jsx(Q,{media:y,setMedia:z,maxFiles:10}),s.jsx("div",{className:"mt-4",children:s.jsx(J,{onSelect:t=>{const o=[...y,t.path];z(o)},selectedMedia:y.map(t=>({path:t})),maxFiles:10})})]}),s.jsxs("div",{className:"sm:col-span-6",children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Содержимое *"}),s.jsx(V,{value:r.content,onChange:$,placeholder:"Начните писать содержимое новости...",minHeight:"320px"}),p.content&&s.jsx("p",{className:"mt-2 text-sm text-red-600",children:p.content}),s.jsx("p",{className:"mt-1 text-xs text-gray-500",children:"Минимум 10 символов"})]})]})}),s.jsx("div",{className:"px-4 py-3 bg-gray-50 text-right sm:px-6",children:s.jsx("button",{type:"submit",className:"inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-blue-300 disabled:cursor-not-allowed",disabled:A||S,children:A||S?"Сохранение...":E?"Сохранить изменения":"Создать новость"})})]})})]})}X.layout=a=>s.jsx(K,{title:"Редактирование новости",children:a});export{X as default};
