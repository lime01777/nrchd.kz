import{r as u,j as e,b as E}from"./app-CJ21qSIO.js";function le({folder:N="",title:y="",limit:z=0,searchTerm:d="",medicine:x="",mkb:p="",category:f="",year:m="",fileType:g="",type:S="",bgColor:H="bg-green-100",useClinicalProtocols:k=!1,onFilesLoaded:V=null,onError:h=null,singleColumn:J=!1,hideDownload:K=!1}){const[C,Y]=u.useState([]),[q,w]=u.useState(!0),[W,F]=u.useState(null),[Q,R]=u.useState(!1),[o,X]=u.useState(null),[Z,L]=u.useState(!1),[G,B]=u.useState(null),[O,D]=u.useState(null);u.useState(null);const[T,ee]=u.useState({}),M=t=>{if(!t||t==="NaN.NaN.NaN")return"";try{const r=new Date(t);if(isNaN(r.getTime()))return t;const n=String(r.getDate()).padStart(2,"0"),l=String(r.getMonth()+1).padStart(2,"0"),a=r.getFullYear();return`${n}.${l}.${a}`}catch{return t}},A=t=>{if(!t||t===0)return"0 Bytes";if(typeof t=="string"){if(t.includes("KB")||t.includes("MB")||t.includes("GB"))return t;if(t=parseInt(t,10),isNaN(t))return"0 Bytes"}const r=1024,n=["Bytes","KB","MB","GB"],l=Math.floor(Math.log(t)/Math.log(r));return parseFloat((t/Math.pow(r,l)).toFixed(1))+" "+n[l]};u.useEffect(()=>{(async()=>{try{w(!0);const r=window.location.origin,n=new URLSearchParams;let l=`${r}/api/files`;if(k){if(l=`${r}/api/clinical-protocols`,N){const s=N.replace(/\\/g,"/");n.append("folder",s)}d&&n.append("search",d),x&&n.append("medicine",x),p&&n.append("mkb",p),f&&n.append("category",f),m&&n.append("year",m),g&&n.append("filetype",g)}else{if(N){const i=N.replace(/\\/g,"/");n.append("folder",i)}y&&n.append("title",y);let s=d||"";x&&(s+=` medicine:${x}`),p&&(s+=` mkb:${p}`),f&&(s+=` category:${f}`),S&&(s+=` type:${S}`),s.trim()!==""&&n.append("search",s.trim())}console.log(`Fetching files from: ${l}${n.toString()?"?"+n.toString():""}`),console.log("Search parameters:",{searchTerm:d,medicine:x,mkb:p,category:f,year:m,fileType:g,type:S,useClinicalProtocols:k,folder:N}),console.log(`Выполняем запрос к API: ${l}${n.toString()?"?"+n.toString():""}`);let a;try{if(a=await E.get(`${l}${n.toString()?"?"+n.toString():""}`),console.log("API response получен:",a),console.log("API response data:",a.data),!a.data){const s="Ответ API не содержит данных";console.error(s),F("Ошибка при загрузке файлов: нет данных"),h&&h(s),w(!1);return}if(a.data.error){const s=`Ошибка API: ${a.data.error}`;console.error(s),F(s),h&&h(s),w(!1);return}}catch(s){const i=`Ошибка при загрузке файлов: ${s.message}`;console.error("Ошибка при запросе к API:",s),console.error("API Endpoint:",l),console.error("Search Parameters:",{searchTerm:d,medicine:x,mkb:p,category:f,year:m,fileType:g,type:S}),F(i),h&&h(i),w(!1);return}let c=[];if(k)if(console.log("Обрабатываем данные клинических протоколов:",a.data),a.data&&a.data.documents)console.log("Найдены документы в response.data.documents:",a.data.documents),c=a.data.documents;else if(a.data&&a.data.protocols)console.log("Найдены протоколы в response.data.protocols:",a.data.protocols),c=a.data.protocols;else{const s="Не найдены ни documents, ни protocols в ответе API. Response data: "+JSON.stringify(a.data);console.error(s),console.error("Full response:",a),h&&h(s),w(!1);return}else a.data&&Array.isArray(a.data)?a.data.forEach(s=>{s.files&&(c=[...c,...s.files]),s.documents&&(c=[...c,...s.documents])}):a.data&&a.data.files&&(c=a.data.files);console.log("Processed files data:",c);const I=c.map(s=>{if(!s.name&&s.url){const i=s.url.split("/"),j=i[i.length-1];return{...s,name:j}}return s}),v=z?I.slice(0,z):I;Y(v);const _=v.map(s=>s.url&&s.url!=="#"?k?Promise.resolve({id:s.id||s.url,size:s.size||"1.2 MB",date:M(s.date||s.created_at||"")}):E.head(s.url).then(i=>{const j=i.headers["content-length"],$=i.headers["last-modified"];return{id:s.id||s.url,size:j?A(j):"0 Bytes",date:M($?new Date($):s.date||s.created_at||"")}}).catch(i=>(console.error("Error fetching file info:",i),{id:s.id||s.url,size:A(s.size||0),date:M(s.date||s.created_at||"")})):Promise.resolve({id:s.id||s.url,size:A(s.size||0),date:M(s.date||s.created_at||"")}));Promise.all(_).then(s=>{const i={};if(s.forEach((j,$)=>{i[v[$].id||v[$].url]=j}),ee(i),V&&Array.isArray(c))try{V(c)}catch(j){console.error("Ошибка при вызове onFilesLoaded:",j),h&&h(`Ошибка при обработке данных: ${j.message}`)}w(!1)}).catch(s=>{console.error("Ошибка при загрузке файлов:",s),F("Ошибка при загрузке файлов. Пожалуйста, попробуйте позже."),w(!1)})}catch(r){console.error("Error fetching files:",r),F("Ошибка при загрузке файлов"),w(!1)}})()},[N,y,z,d,x,p,f,m,g,k]);const te=t=>{if(console.log("Getting icon for file:",t),!t||typeof t!="string")return"1";const r=t.split(".").pop().toLowerCase();switch(console.log("File extension:",r),r){case"pdf":return"2";case"xls":case"xlsx":return"3";case"txt":return"4";case"ppt":case"pptx":return"5";case"doc":case"docx":return"1";case"mp4":case"avi":case"mov":return"6";case"jpg":case"jpeg":case"png":case"gif":return"7";default:return"1"}},se=t=>{if(!t||typeof t!="string")return"";const r=t.split(".").pop().toLowerCase();switch(r){case"pdf":return"PDF";case"doc":case"docx":return"DOCX";case"xls":case"xlsx":return"XLSX";case"ppt":case"pptx":return"PPTX";case"txt":return"TXT";case"mp4":case"avi":case"mov":return"MP4";case"jpg":case"jpeg":case"png":return"JPG";default:return r.toUpperCase()}},b=t=>{if(!t||typeof t!="string")return null;const r=t.split(".").pop().toLowerCase();return["pdf"].includes(r)?"pdf":["jpg","jpeg","png","gif","webp"].includes(r)?"image":["doc","docx"].includes(r)?"word":["xls","xlsx"].includes(r)?"excel":["ppt","pptx"].includes(r)?"powerpoint":["txt"].includes(r)?"text":["mp4","avi","mov"].includes(r)?"video":null},re=t=>!t||t==="#"?"":t.startsWith("http://")||t.startsWith("https://")?t:`${window.location.origin}${t.startsWith("/")?"":"/"}${t}`,ne=t=>{try{L(!0),D(null);const r=t.url||"",n=re(r),a=`https://docs.google.com/viewer?url=${encodeURIComponent(n)}&embedded=true`;return B(a),L(!1),a}catch(r){return console.error("Ошибка при конвертации документа:",r),D("Не удалось подготовить документ для просмотра"),L(!1),null}},ae=(t,r)=>{r&&r.preventDefault(),console.log("Opening file:",t),X(t),R(!0),document.body.style.overflow="hidden";const n=t.name||"";console.log("File name for determining type:",n);const l=b(n);console.log("Detected file type:",l),["word","excel","powerpoint"].includes(l)?ne(t):l==="video"&&typeof onVideoClick=="function"?(onVideoClick(t.url,t.description||t.name||"Видео"),P()):B(null)},P=()=>{R(!1),document.body.style.overflow="auto",X(null),B(null),L(!1),D(null)},U=u.useMemo(()=>(!d||d.trim()==="")&&!x&&!p&&!f&&!m&&!g?C:C.filter(t=>{if(d&&d.trim()!==""){const r=d.toLowerCase().trim(),n=(t.name||"").toLowerCase(),l=(t.description||"").toLowerCase();if(!n.includes(r)&&!l.includes(r))return!1}return!(x&&t.medicine!==x||p&&t.mkb!==p||f&&t.category!==f||m&&t.year!==parseInt(m)||g&&t.filetype!==g.toLowerCase())}),[C,d,x,p,f,m,g,S]);return q?e.jsxs("div",{className:"py-8 text-center",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-green-500"}),e.jsx("p",{className:"mt-2","data-translate":!0,children:"Загрузка файлов..."})]}):W?e.jsx("div",{className:"py-8 text-center text-red-500",children:W}):e.jsxs("div",{className:`py-6 ${H}`,children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[y&&e.jsx("h2",{className:"text-2xl font-semibold text-gray-800",children:y}),e.jsxs("div",{className:"text-sm font-medium text-gray-600",children:["Всего найдено: ",e.jsx("span",{className:"font-bold",children:U.length})]})]}),U.length===0?e.jsx("div",{className:"py-8 text-center text-gray-500 bg-white rounded-lg shadow border border-gray-200","data-translate":!0,children:"Нет доступных документов"}):e.jsx("div",{className:`grid ${J?"grid-cols-1":"grid-cols-1 md:grid-cols-2 lg:grid-cols-3"} gap-4`,children:U.map((t,r)=>{const n=t.name||"",l=t.description||t.name||"Файл",a=t.id||t.url,c=T[a]||{size:"0 Bytes",date:""},I=se(n),v=te(n);return console.log("Rendering file:",n,"Icon type:",v),e.jsx("div",{className:"w-full",children:e.jsxs("div",{className:"flex flex-col h-[250px] bg-white p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200 border border-gray-200",children:[e.jsxs("div",{className:"flex-grow overflow-hidden",children:[e.jsx("h2",{className:"font-medium leading-normal text-gray-800 line-clamp-4 mb-3",children:l}),e.jsxs("div",{className:"flex flex-wrap gap-1 mb-2",children:[t.medicine&&e.jsxs("span",{className:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800",children:["Раздел: ",t.medicine]}),t.mkb&&e.jsxs("span",{className:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800",children:["МКБ: ",t.mkb]})]})]}),e.jsxs("div",{className:"flex mt-auto justify-between items-center",children:[e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{onClick:_=>ae(t,_),className:"cursor-pointer text-black inline-flex items-center border-gray-300 border rounded-lg px-3 py-2 text-sm hover:bg-gray-50 transition-colors duration-200",children:e.jsx("span",{"data-translate":!0,children:"Открыть"})}),!K&&e.jsx("a",{href:t.url,download:!0,className:"cursor-pointer text-black inline-flex items-center border-gray-300 border rounded-lg px-3 py-2 text-sm hover:bg-gray-50 transition-colors duration-200",children:e.jsx("span",{"data-translate":!0,children:"Скачать"})})]}),e.jsxs("div",{className:"flex flex-col text-sm",children:[e.jsxs("div",{className:"flex flex-row items-center",children:[e.jsx("img",{src:`/img/FileType/${v}.png`,alt:"",className:"w-4 h-4"}),e.jsxs("p",{className:"ml-1 uppercase text-xs text-gray-600",children:[I,", ",c.size]})]}),e.jsx("p",{className:"text-gray-400 text-xs text-right",children:c.date})]})]})]})},r)})}),Q&&o&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50",onClick:P,children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-5xl w-full max-h-[90vh] flex flex-col",onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center p-4 border-b",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-800 truncate",children:o.description||o.name||"Файл"}),e.jsx("button",{onClick:P,className:"text-gray-500 hover:text-gray-700 focus:outline-none",children:e.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsx("div",{className:"flex-grow p-4 overflow-auto",children:Z?e.jsxs("div",{className:"flex flex-col items-center justify-center h-[70vh]",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-gray-900 mb-4"}),e.jsx("p",{className:"text-gray-600","data-translate":!0,children:"Подготовка документа к просмотру..."})]}):O?e.jsxs("div",{className:"flex flex-col items-center justify-center h-[70vh]",children:[e.jsx("div",{className:"text-red-500 mb-4",children:e.jsx("svg",{className:"w-16 h-16",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})}),e.jsx("p",{className:"text-gray-600 mb-4",children:O}),e.jsx("a",{href:o.url,target:"_blank",rel:"noopener noreferrer",className:"bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors duration-200",children:"Скачать файл"})]}):b(o.name)==="image"?e.jsx("div",{className:"flex items-center justify-center h-[70vh]",children:e.jsx("img",{src:o.url,alt:o.description||o.name,className:"max-w-full max-h-[70vh] object-contain"})}):b(o.name)==="pdf"?e.jsx("div",{className:"flex flex-col items-center justify-center h-[70vh]",children:e.jsx("div",{className:"w-full h-full",children:e.jsx("object",{data:o.url,type:"application/pdf",className:"w-full h-full min-h-[70vh]",children:e.jsxs("p",{children:["Ваш браузер не поддерживает встроенный просмотр PDF.",e.jsx("a",{href:o.url,target:"_blank",rel:"noopener noreferrer",children:"Скачайте PDF"}),"."]})})})}):b(o.name)==="video"?e.jsx("div",{className:"flex flex-col items-center justify-center h-[70vh]",children:e.jsx("div",{className:"w-full h-full",children:e.jsx("video",{src:o.url,className:"max-w-full max-h-[70vh]",controls:!0,autoPlay:!0})})}):["word","excel","powerpoint"].includes(b(o.name))&&G?e.jsx("div",{className:"flex flex-col items-center justify-center h-[70vh]",children:e.jsx("div",{className:"w-full h-full",children:e.jsx("iframe",{src:G,className:"w-full h-full min-h-[70vh]",title:o.description||o.name,frameBorder:"0"})})}):["word","excel","powerpoint"].includes(b(o.name))?e.jsxs("div",{className:"flex flex-col items-center justify-center h-[70vh]",children:[e.jsx("div",{className:"text-blue-500 mb-4",children:e.jsx("svg",{className:"w-16 h-16",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})})}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Предпросмотр для этого типа файла недоступен"}),e.jsx("a",{href:o.url,target:"_blank",rel:"noopener noreferrer",className:"bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors duration-200",children:"Скачать файл"})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-[70vh]",children:[e.jsx("div",{className:"text-gray-500 mb-4",children:e.jsx("svg",{className:"w-16 h-16",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})})}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Предпросмотр для этого типа файла недоступен"}),e.jsx("a",{href:o.url,target:"_blank",rel:"noopener noreferrer",className:"bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors duration-200",children:"Скачать файл"})]})}),e.jsxs("div",{className:"p-4 border-t flex justify-end",children:[e.jsx("a",{href:o.url,target:"_blank",rel:"noopener noreferrer",className:"bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-lg mr-2 transition-colors duration-200",children:"Открыть в новой вкладке"}),e.jsx("button",{onClick:P,className:"bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors duration-200",children:"Закрыть"})]})]})})]})}export{le as S};
