import{r as u,j as e,W,y as I,a as O}from"./app-C8K1oLkQ.js";import{A as G}from"./AdminLayout-CBM0px28.js";import{T as F,I as m}from"./TextInput-Tib9XzNQ.js";import{I as b}from"./InputLabel-CyIk-Kgh.js";import{P as B}from"./PrimaryButton-CTY6muXY.js";import{M as q}from"./ModernMediaUploader-CeqXN5hv.js";import{u as J,j as z,n as K,o as X,l as Q}from"./index-B89BxFe2.js";import"./transition-COR0OOVW.js";import"./use-is-mounted-BTDAMJFX.js";function V({name:t="cover",label:E="Обложка",currentImageUrl:s=null,currentImageAlt:A=null,onImageChange:d=null,errors:v={}}){const[y,x]=u.useState(s),[i,r]=u.useState(!1),f=u.useRef(null),c=o=>{if(!["image/jpeg","image/jpg","image/png","image/webp"].includes(o.type)){alert("Недопустимый тип файла. Разрешены: JPG, PNG, WebP");return}const l=5*1024*1024;if(o.size>l){alert("Размер файла не должен превышать 5 МБ");return}const N=new Image;N.onload=()=>{if(N.width<800||N.height<400){alert("Минимальный размер изображения: 800×400 пикселей");return}const D=new FileReader;D.onload=P=>{x(P.target.result),d&&d(o)},D.readAsDataURL(o)},N.onerror=()=>{alert("Ошибка при загрузке изображения")},N.src=URL.createObjectURL(o)},S=()=>{var o;(o=f.current)==null||o.click()},L=o=>{var l;const p=(l=o.target.files)==null?void 0:l[0];p&&c(p)},k=o=>{o.preventDefault(),o.stopPropagation(),o.type==="dragenter"||o.type==="dragover"?r(!0):o.type==="dragleave"&&r(!1)},j=o=>{var l;o.preventDefault(),o.stopPropagation(),r(!1);const p=(l=o.dataTransfer.files)==null?void 0:l[0];p&&c(p)},C=()=>{x(null),f.current&&(f.current.value=""),d&&d(null)};return e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:E}),y&&e.jsxs("div",{className:"relative inline-block",children:[e.jsx("img",{src:y,alt:A||"Превью обложки",className:"max-w-full h-auto rounded-lg border border-gray-300 shadow-sm",style:{maxHeight:"400px"}}),e.jsx("button",{type:"button",onClick:C,className:"absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 transition-colors",title:"Удалить изображение",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsxs("div",{onClick:S,onDragEnter:k,onDragLeave:k,onDragOver:k,onDrop:j,className:`
                    border-2 border-dashed rounded-lg p-6 text-center cursor-pointer transition-colors
                    ${i?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-gray-400"}
                    ${y?"hidden":""}
                `,children:[e.jsx("input",{ref:f,type:"file",name:t,accept:"image/jpeg,image/jpg,image/png,image/webp",onChange:L,className:"hidden"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("svg",{className:"mx-auto h-12 w-12 text-gray-400",stroke:"currentColor",fill:"none",viewBox:"0 0 48 48",children:e.jsx("path",{d:"M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"})}),e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"font-semibold text-blue-600",children:"Нажмите для загрузки"})," или перетащите файл сюда"]}),e.jsx("div",{className:"text-xs text-gray-500",children:"JPG, PNG, WebP (макс. 5 МБ, мин. 800×400px)"})]})]}),v[t]&&e.jsx("p",{className:"text-sm text-red-600",children:v[t]})]})}function oe({news:t=null,media:E=[],section:s=null,type:A="news"}){var T;const d=!!t,v=Array.isArray(t==null?void 0:t.media)?t.media:Array.isArray(E)?E:[],y=((T=document.querySelector('meta[name="csrf-token"]'))==null?void 0:T.getAttribute("content"))??"",x=A||(s==null?void 0:s.type)||(t==null?void 0:t.type)||"news",{data:i,setData:r,processing:f,errors:c,reset:S}=W({title:(t==null?void 0:t.title)||"",slug:(t==null?void 0:t.slug)||"",excerpt:(t==null?void 0:t.excerpt)||"",body:(t==null?void 0:t.body)||"",cover:null,cover_image_alt:(t==null?void 0:t.cover_image_alt)||"",seo_title:(t==null?void 0:t.seo_title)||"",seo_description:(t==null?void 0:t.seo_description)||"",status:(t==null?void 0:t.status)||"draft",published_at:(t==null?void 0:t.published_at)||"",media:v,type:x}),[L,k]=u.useState(null),[j,C]=u.useState(v),[o,p]=u.useState(!1),l=J({extensions:[z.configure({bulletList:!0,orderedList:!0,link:!1}),K.configure({inline:!1,allowBase64:!0}),X.configure({openOnClick:!1})],content:i.body,onUpdate:({editor:a})=>{r("body",a.getHTML())}});u.useEffect(()=>{l&&d&&(t!=null&&t.body)&&l.commands.setContent(t.body)},[l,d,t==null?void 0:t.body]),u.useEffect(()=>{var a;d||(a=l==null?void 0:l.commands)==null||a.setContent(i.body||"")},[l]),u.useEffect(()=>{C(v),r("media",v)},[v,t==null?void 0:t.id,r]);const N=()=>{const a=i.title.toLowerCase().replace(/[^-\uFFFF\w\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").trim();r("slug",a)},D=a=>{k(a),r("cover",a)},P=u.useCallback(a=>{!a||a.length===0||C(g=>{const n=a.map((_,M)=>({..._,position:_.position??g.length+M})),h=[...g,...n];return r("media",h),h})},[r]),$=u.useCallback(async a=>{const g=j.find(n=>n.id===a);if(C(n=>{const h=n.filter(_=>_.id!==a);return r("media",h),h}),!(!y||!(g!=null&&g.path)))try{await fetch("/admin/news/media/temp",{method:"DELETE",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":y},body:JSON.stringify({path:g.path})})}catch(n){console.error("Ошибка удаления медиа файла",n)}},[j,y,r]),R=u.useCallback((a=null,g=null)=>{a&&a.preventDefault();const n=g??i.status;r("status",n);const h={...i,status:n,media:j,cover:L??i.cover,body:l?l.getHTML():i.body,type:x};L||delete h.cover;const _=()=>{p(!1)},M=()=>{var U;d||(S(),k(null),C([]),r("media",[]),(U=l==null?void 0:l.commands)==null||U.clearContent(!0))};d?I.post(route("admin.news.update",{news:t.id,type:x}),h,{forceFormData:!0,onFinish:_,onSuccess:M}):I.post(route("admin.news.store",{type:x}),h,{forceFormData:!0,onFinish:_,onSuccess:M})},[i,j,L,d,t==null?void 0:t.id,l,S,r]),H=u.useCallback(()=>{p(!0),R(null,"published")},[R]);return e.jsx(G,{title:s==null?void 0:s.title,children:e.jsx("div",{className:"py-8",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:d?(s==null?void 0:s.editLabel)||"Редактировать новость":(s==null?void 0:s.createLabel)||"Создать новость"}),(s==null?void 0:s.subtitle)&&e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:s.subtitle}),e.jsxs(O,{href:route("admin.news.index",{type:x}),className:"mt-2 inline-flex items-center text-sm text-blue-600 hover:text-blue-800",children:[e.jsx("span",{className:"mr-2",children:"←"}),(s==null?void 0:s.returnLabel)||"Вернуться к списку"]})]}),e.jsxs("form",{onSubmit:a=>R(a),className:"space-y-6",children:[e.jsxs("div",{className:"bg-white shadow rounded-lg p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx(b,{htmlFor:"title",value:"Заголовок *"}),e.jsx(F,{id:"title",type:"text",value:i.title,onChange:a=>r("title",a.target.value),className:"mt-1 block w-full",required:!0}),e.jsx(m,{message:c.title,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(b,{htmlFor:"slug",value:"URL-адрес (slug)"}),e.jsx("button",{type:"button",onClick:N,className:"text-sm text-blue-600 hover:text-blue-800",children:"Обновить из заголовка"})]}),e.jsx(F,{id:"slug",type:"text",value:i.slug,onChange:a=>r("slug",a.target.value),className:"mt-1 block w-full",placeholder:"Автоматически генерируется из заголовка"}),e.jsx(m,{message:c.slug,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(b,{htmlFor:"excerpt",value:"Краткое описание"}),e.jsx("textarea",{id:"excerpt",value:i.excerpt,onChange:a=>r("excerpt",a.target.value),className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",rows:3,placeholder:"Краткое описание новости для превью..."}),e.jsx(m,{message:c.excerpt,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(b,{htmlFor:"body",value:"Текст новости *"}),e.jsxs("div",{className:"mt-1 border border-gray-300 rounded-md",children:[l&&e.jsxs("div",{className:"border-b border-gray-200 p-2 flex flex-wrap gap-2",children:[e.jsx("button",{type:"button",onClick:()=>l.chain().focus().toggleBold().run(),className:`px-3 py-1 rounded text-sm ${l.isActive("bold")?"bg-gray-200 font-semibold":"hover:bg-gray-100"}`,children:"Жирный"}),e.jsx("button",{type:"button",onClick:()=>l.chain().focus().toggleItalic().run(),className:`px-3 py-1 rounded text-sm italic ${l.isActive("italic")?"bg-gray-200":"hover:bg-gray-100"}`,children:"Курсив"}),e.jsx("button",{type:"button",onClick:()=>l.chain().focus().toggleBulletList().run(),className:`px-3 py-1 rounded text-sm ${l.isActive("bulletList")?"bg-gray-200":"hover:bg-gray-100"}`,children:"Список"}),e.jsx("button",{type:"button",onClick:()=>l.chain().focus().setParagraph().run(),className:"px-3 py-1 rounded text-sm hover:bg-gray-100",children:"Абзац"})]}),e.jsx(Q,{editor:l,className:"prose max-w-none p-4 min-h-[320px] focus:outline-none"})]}),e.jsx(m,{message:c.body,className:"mt-2"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsx(V,{name:"cover",label:"Обложка",currentImageUrl:t==null?void 0:t.cover_url,currentImageAlt:t==null?void 0:t.cover_image_alt,onImageChange:D,errors:c}),e.jsxs("div",{children:[e.jsx(b,{htmlFor:"cover_image_alt",value:"Альтернативный текст обложки (для SEO)"}),e.jsx(F,{id:"cover_image_alt",type:"text",value:i.cover_image_alt,onChange:a=>r("cover_image_alt",a.target.value),className:"mt-1 block w-full",placeholder:"Описание изображения для поисковых систем"}),e.jsx(m,{message:c.cover_image_alt,className:"mt-2"})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx(b,{htmlFor:"seo_title",value:"SEO заголовок"}),e.jsx(F,{id:"seo_title",type:"text",value:i.seo_title,onChange:a=>r("seo_title",a.target.value),className:"mt-1 block w-full",placeholder:"Если не указано — используется основной заголовок"}),e.jsx(m,{message:c.seo_title,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(b,{htmlFor:"seo_description",value:"SEO описание"}),e.jsx("textarea",{id:"seo_description",value:i.seo_description,onChange:a=>r("seo_description",a.target.value),className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",rows:2,placeholder:"Если не указано — используется краткое описание"}),e.jsx(m,{message:c.seo_description,className:"mt-2"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx(b,{htmlFor:"status",value:"Статус *"}),e.jsxs("select",{id:"status",value:i.status,onChange:a=>r("status",a.target.value),className:"mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500",required:!0,children:[e.jsx("option",{value:"draft",children:"Черновик"}),e.jsx("option",{value:"published",children:"Опубликовано"})]}),e.jsx(m,{message:c.status,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(b,{htmlFor:"published_at",value:"Дата и время публикации"}),e.jsx(F,{id:"published_at",type:"datetime-local",value:i.published_at,onChange:a=>r("published_at",a.target.value),className:"mt-1 block w-full"}),e.jsx(m,{message:c.published_at,className:"mt-2"})]})]})]}),e.jsxs("div",{className:"bg-white shadow rounded-lg p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-medium text-gray-900",children:"Галерея"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Загрузите дополнительные изображения или видео (поддерживаются форматы jpg, png, webp, mp4 и др.)."})]}),e.jsxs("span",{className:"text-sm text-gray-400",children:["Файлов: ",j.length]})]}),e.jsx(q,{existingMedia:j,onMediaUploaded:P,onMediaRemoved:$,maxFiles:30}),e.jsx(m,{message:c.media,className:"mt-2"})]}),e.jsxs("div",{className:"flex flex-wrap justify-end gap-4",children:[e.jsx(O,{href:route("admin.news.index",{type:x}),className:"px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50",children:"Отмена"}),e.jsx(B,{type:"submit",disabled:f||o,className:"px-4 py-2",children:f?"Сохранение...":d?"Сохранить изменения":(s==null?void 0:s.createLabel)||"Создать запись"}),!d&&e.jsx(B,{type:"button",disabled:f||o,onClick:H,className:"px-4 py-2 bg-green-600 hover:bg-green-700",children:o?"Публикация...":"Сохранить и опубликовать"})]})]})]})})})}export{oe as default};
