import{r as m,W as R,j as e,a as q}from"./app-CGhPQDTK.js";import{A as G}from"./AdminLayout-rwXq3oLr.js";import{S as $,C as H,M as K}from"./SimpleImageManager-DQM1oSQV.js";import"./transition-CDdRSlB_.js";import"./use-is-mounted-B8ssZCq5.js";const b=["Общие","Аккредитация","Обучение","Конференции","Методические материалы","Исследования","Филиалы","Анонсы событий"];function Q({news:s=null}){const y=!!s,[k,x]=m.useState(!1),{data:r,setData:i,post:S,put:V,processing:A,errors:d}=R({title:(s==null?void 0:s.title)||"",category:Array.isArray(s==null?void 0:s.category)?s.category:s!=null&&s.category?[s.category]:[],content:typeof(s==null?void 0:s.content)=="string"?s.content:"",images:(s==null?void 0:s.images)||[],status:(s==null?void 0:s.status)||"Черновик",publishDate:(s==null?void 0:s.publishDate)||new Date().toISOString().substr(0,10)});m.useEffect(()=>{s&&console.log("Загруженные данные новости:",{title:s.title,images:s.images,main_image:s.main_image})},[s]);const[g,D]=m.useState(()=>{if(s!=null&&s.category){const t=Array.isArray(s.category)?s.category:[s.category];return Array.from(new Set([...b,...t]))}return b}),[u,f]=m.useState(Array.isArray(r.category)?r.category:r.category?[r.category]:[]),[v,E]=m.useState(""),[j,L]=m.useState(!1),[h,I]=m.useState(r.images||[]),[F,J]=m.useState(!1);console.log("NewsEdit - данные новости:",{news:s,data:r,images:r.images,imagesType:typeof r.images}),m.useEffect(()=>{r.images&&r.images.length>0&&I(r.images)},[]),m.useEffect(()=>{const t=a=>{j&&!a.target.closest(".category-dropdown")&&L(!1)};return document.addEventListener("mousedown",t),()=>{document.removeEventListener("mousedown",t)}},[j]);const M=t=>{console.log("Edit - изменение изображений:",t);const a=Array.isArray(t)?t:[];I(a);const o=[],n=[];a.forEach(c=>{c instanceof File?o.push(c):typeof c=="string"&&c.trim().length>0&&n.push(c)}),console.log("Edit - разделенные файлы и URL:",{files:o,urls:n,totalImages:a.length}),i(c=>({...c,images:n,image_files:o}))},w=(t,a)=>{let o;a?o=[...u,t]:o=u.filter(n=>n!==t),f(o),i("category",o)},_=()=>{const t=v.trim();if(!t){alert("Введите название категории");return}if(g.includes(t)){alert("Такая категория уже существует");return}if(t.length<2){alert("Название категории должно содержать минимум 2 символа");return}if(t.length>50){alert("Название категории не должно превышать 50 символов");return}const a=[...g,t];D(a);const o=[...u,t];f(o),i("category",o),E("")},P=t=>{if(!confirm(`Вы уверены, что хотите удалить категорию "${t}"?`))return;const a=u.filter(n=>n!==t);f(a),i("category",a);const o=g.filter(n=>n!==t);D(o)},T=()=>{f([...g]),i("category",[...g])},U=()=>{f([]),i("category",[])},W=()=>{const t=g.filter(a=>!u.includes(a));f(t),i("category",t)},z=t=>{t.preventDefault(),x(!0);try{const a=r.category||[];if(console.log("Изображения перед отправкой:",{images:h,data_images:r.images}),!r.title||r.title.trim().length===0){alert("Заполните заголовок"),x(!1);return}if(Array.isArray(r.category)||i("category",typeof r.category=="string"?[r.category]:[]),typeof r.content!="string"&&i("content",String(r.content||"")),["Черновик","Опубликовано","Запланировано"].includes(r.status)||i("status","Черновик"),!r.content||r.content.replace(/<[^>]*?>/g,"").trim().length<10){alert("Содержимое должно содержать минимум 10 символов"),x(!1);return}if(a.length===0){alert("Выберите хотя бы одну категорию"),x(!1);return}console.log("Состояние изображений перед валидацией:",{images:h,imagesLength:h?h.length:0,imagesType:typeof h});const o=h.filter(l=>{const p=l&&(typeof l=="string"||l instanceof File&&l.size>0);return p||console.warn("Невалидное изображение:",l),p});console.log("Валидные изображения:",o);const n=[],c=[];o.forEach(l=>{l instanceof File?(console.log("Добавляем файл:",l.name,l.size),n.push(l)):typeof l=="string"&&(console.log("Добавляем URL:",l),c.push(l))}),console.log("Финальное разделение:",{files:n,urls:c});const N={title:r.title,content:r.content,status:r.status,publishDate:r.publishDate||"",category:a,images:c,_method:y?"PUT":"POST"};n.length>0&&(N.image_files=n),console.log("Финальные данные для отправки:",N);const O={preserveScroll:!0,forceFormData:n.length>0,onSuccess:l=>{console.log("Успешное сохранение:",l),x(!1)},onError:l=>{console.error("Ошибки валидации:",l),x(!1);const p=[];Object.keys(l).forEach(C=>{Array.isArray(l[C])?p.push(...l[C]):p.push(l[C])}),p.length>0&&alert(`Ошибки валидации:
`+p.join(`
`))},onFinish:()=>{x(!1)}};S(y?route("admin.news.update",s.id):route("admin.news.store"),N,O)}catch(a){console.error("Ошибка при отправке формы:",a),x(!1),alert("Произошла ошибка при отправке формы")}},B=t=>{i("content",t)};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-6 flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:y?"Редактирование новости":"Создание новости"}),e.jsxs(q,{href:route("admin.news"),className:"inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:[e.jsx("svg",{className:"h-5 w-5 mr-2",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M10 19l-7-7m0 0l7-7m-7 7h18"})}),"Назад к списку"]})]}),e.jsx("div",{className:"bg-white shadow overflow-hidden sm:rounded-lg",children:e.jsxs("form",{onSubmit:z,className:"min-h-full",children:[e.jsx("div",{className:"px-4 py-5 sm:p-6",children:e.jsxs("div",{className:"grid grid-cols-1 gap-6 sm:grid-cols-6",children:[e.jsxs("div",{className:"sm:col-span-6",children:[e.jsx("label",{htmlFor:"title",className:"block text-sm font-medium text-gray-700",children:"Заголовок *"}),e.jsx("div",{className:"mt-1",children:e.jsx("input",{type:"text",name:"title",id:"title",value:r.title,onChange:t=>i("title",t.target.value),className:"shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md",required:!0,placeholder:"Введите заголовок новости"})}),d.title&&e.jsx("p",{className:"mt-2 text-sm text-red-600",children:d.title})]}),e.jsxs("div",{className:"sm:col-span-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Категории *"}),e.jsxs("div",{className:"relative category-dropdown",children:[e.jsxs("button",{type:"button",onClick:()=>L(!j),className:"w-full flex items-center justify-between px-3 py-2 border border-gray-300 rounded-md bg-white text-left text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("span",{className:u.length>0?"text-gray-900":"text-gray-500",children:u.length>0?`Выбрано: ${u.length} категорий`:"Выберите категории..."}),e.jsx("svg",{className:"w-5 h-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M19 9l-7 7-7-7"})})]}),j&&e.jsx("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto",children:e.jsxs("div",{className:"p-2",children:[e.jsxs("div",{className:"flex gap-2 mb-3 pb-2 border-b border-gray-200",children:[e.jsx("button",{type:"button",onClick:T,className:"px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600",children:"Выбрать все"}),e.jsx("button",{type:"button",onClick:U,className:"px-2 py-1 text-xs bg-gray-600 text-white rounded hover:bg-gray-700",children:"Снять выбор"}),e.jsx("button",{type:"button",onClick:W,className:"px-2 py-1 text-xs bg-purple-500 text-white rounded hover:bg-purple-600",children:"Инвертировать"})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx("h5",{className:"text-xs font-medium text-gray-600 mb-2 uppercase tracking-wide",children:"Стандартные категории"}),e.jsx("div",{className:"space-y-1",children:g.filter(t=>b.includes(t)).map(t=>e.jsxs("label",{className:"flex items-center justify-between p-2 hover:bg-gray-50 rounded cursor-pointer",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",checked:u.includes(t),onChange:a=>w(t,a.target.checked),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),e.jsx("span",{className:"ml-2 text-sm text-gray-700",children:t})]}),e.jsx("span",{className:"text-xs text-gray-400 px-2 py-1 bg-gray-100 rounded",children:"Стандартная"})]},t))})]}),g.filter(t=>!b.includes(t)).length>0&&e.jsxs("div",{className:"mb-3",children:[e.jsx("h5",{className:"text-xs font-medium text-gray-600 mb-2 uppercase tracking-wide",children:"Пользовательские категории"}),e.jsx("div",{className:"space-y-1",children:g.filter(t=>!b.includes(t)).map(t=>e.jsxs("label",{className:"flex items-center justify-between p-2 hover:bg-gray-50 rounded cursor-pointer",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",checked:u.includes(t),onChange:a=>w(t,a.target.checked),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),e.jsx("span",{className:"ml-2 text-sm text-gray-700",children:t})]}),e.jsx("button",{type:"button",onClick:a=>{a.preventDefault(),a.stopPropagation(),P(t)},className:"text-red-500 hover:text-red-700 p-1 rounded hover:bg-red-50 transition-colors",title:"Удалить категорию",children:e.jsx("svg",{className:"h-3 w-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M6 18L18 6M6 6l12 12"})})})]},t))})]}),e.jsx("div",{className:"pt-2 border-t border-gray-200",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:v,onChange:t=>E(t.target.value),onKeyPress:t=>{t.key==="Enter"&&(t.preventDefault(),_())},placeholder:"Новая категория",className:"flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"}),e.jsx("button",{type:"button",onClick:_,disabled:!v.trim()||F,className:"px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600 disabled:bg-gray-300 disabled:cursor-not-allowed",children:F?"...":"Добавить"})]})})]})})]}),d.category&&e.jsx("p",{className:"mt-2 text-sm text-red-600",children:d.category})]}),e.jsxs("div",{className:"sm:col-span-3",children:[e.jsx("label",{htmlFor:"status",className:"block text-sm font-medium text-gray-700",children:"Статус *"}),e.jsx("div",{className:"mt-1",children:e.jsxs("select",{id:"status",name:"status",value:r.status,onChange:t=>i("status",t.target.value),className:"shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md",required:!0,children:[e.jsx("option",{value:"Черновик",children:"Черновик"}),e.jsx("option",{value:"Опубликовано",children:"Опубликовано"}),e.jsx("option",{value:"Запланировано",children:"Запланировано"})]})}),d.status&&e.jsx("p",{className:"mt-2 text-sm text-red-600",children:d.status})]}),e.jsxs("div",{className:"sm:col-span-3",children:[e.jsx("label",{htmlFor:"publishDate",className:"block text-sm font-medium text-gray-700",children:"Дата публикации"}),e.jsx("div",{className:"mt-1",children:e.jsx("input",{type:"date",name:"publishDate",id:"publishDate",value:r.publishDate,onChange:t=>i("publishDate",t.target.value),className:"shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md"})}),d.publishDate&&e.jsx("p",{className:"mt-2 text-sm text-red-600",children:d.publishDate})]}),e.jsxs("div",{className:"sm:col-span-6",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:["Галерея изображений",e.jsx("span",{className:"text-xs text-gray-500 ml-2",children:"- Добавьте до 10 изображений для слайдера"})]}),e.jsx($,{onSelect:t=>{const a=[...h,t.path];M(a)},selectedImages:h.map(t=>({path:t}))}),e.jsx(H,{images:h,setImages:M,maxImages:10})]}),e.jsxs("div",{className:"sm:col-span-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Содержимое *"}),e.jsx(K,{value:r.content,onChange:B,placeholder:"Начните писать содержимое новости...",minHeight:"320px"}),d.content&&e.jsx("p",{className:"mt-2 text-sm text-red-600",children:d.content}),e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:"Минимум 10 символов"})]})]})}),e.jsx("div",{className:"px-4 py-3 bg-gray-50 text-right sm:px-6",children:e.jsx("button",{type:"submit",className:"inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-blue-300 disabled:cursor-not-allowed",disabled:A||k,children:A||k?"Сохранение...":y?"Сохранить изменения":"Создать новость"})})]})})]})}Q.layout=s=>e.jsx(G,{title:"Редактирование новости",children:s});export{Q as default};
