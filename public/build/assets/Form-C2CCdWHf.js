import{r as n,W as G,y as $,j as e,a as B}from"./app-B5jbyLNa.js";import{A as Q}from"./AdminLayout-KPmKzhPg.js";import{T as N,I as g}from"./TextInput-D1u1pCkq.js";import{I as p}from"./InputLabel-3mtABGbk.js";import{P as D}from"./PrimaryButton-B3p76bpe.js";import{M as V}from"./ModernMediaUploader-B8mA1yx6.js";import{C as Y}from"./CategorySelector-kaLQcmi-.js";import{u as Z,j as w,n as ee,o as te,l as se}from"./index-2MI6CY3z.js";import"./transition-DNjSmlbT.js";import"./use-is-mounted-C3nqqKtb.js";function xe({news:t=null,media:C=[],section:P="news",sectionMeta:q=null,type:H="news",availableCategories:S=[]}){var I;const d=!!t,r=q||{},J=P||H||(t==null?void 0:t.type)||"news",f=n.useMemo(()=>Array.isArray(t==null?void 0:t.media)?t.media:Array.isArray(C)?C:[],[t==null?void 0:t.media,C]),_=n.useMemo(()=>Array.isArray(t==null?void 0:t.category)?t.category:[],[t==null?void 0:t.category]),k=((I=document.querySelector('meta[name="csrf-token"]'))==null?void 0:I.getAttribute("content"))??"",h=J,A=h==="news"?route("admin.news.index"):route("admin.news.index",h),{data:o,setData:l,processing:F,errors:m,reset:M}=G({title:(t==null?void 0:t.title)||"",slug:(t==null?void 0:t.slug)||"",excerpt:(t==null?void 0:t.excerpt)||"",body:(t==null?void 0:t.body)||"",seo_title:(t==null?void 0:t.seo_title)||"",seo_description:(t==null?void 0:t.seo_description)||"",status:(t==null?void 0:t.status)||"draft",published_at:(t==null?void 0:t.published_at)||"",media:f,type:h,section:h,category:_}),[b,j]=n.useState(f),[E,T]=n.useState(!1),a=Z({extensions:[w.configure({bulletList:!0,orderedList:!0,link:!1}),ee.configure({inline:!1,allowBase64:!0}),te.configure({openOnClick:!1})],content:o.body,onUpdate:({editor:s})=>{l("body",s.getHTML())}});n.useEffect(()=>{a&&d&&(t!=null&&t.body)&&a.commands.setContent(t.body)},[a,d,t==null?void 0:t.body]),n.useEffect(()=>{var s;d||(s=a==null?void 0:a.commands)==null||s.setContent(o.body||"")},[a]),n.useEffect(()=>{!d&&!(t!=null&&t.id)||(j(f),l("media",f),l("category",_))},[d,t==null?void 0:t.id,f,_]);const K=()=>{const s=o.title.toLowerCase().replace(/[^-\uFFFF\w\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").trim();l("slug",s)},W=n.useCallback(s=>{!s||s.length===0||j(i=>{const x=s.map((y,v)=>({...y,position:y.position??i.length+v})),c=[...i,...x];return l("media",c),c})},[l]),X=n.useCallback(async s=>{const i=b.find(x=>x.id===s);if(j(x=>{const c=x.filter(y=>y.id!==s);return l("media",c),c}),!(!k||!(i!=null&&i.path)||i!=null&&i.is_external||(i==null?void 0:i.source)==="external"))try{await fetch("/admin/news/media/temp",{method:"DELETE",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":k},body:JSON.stringify({path:i.path})})}catch(x){console.error("Ошибка удаления медиа файла",x)}},[b,k,l]),L=n.useCallback((s=null,i=null)=>{var O,R;s&&s.preventDefault();const x=i??o.status;l("status",x);const c={...o,status:x,media:b,body:a?a.getHTML():o.body,type:h,section:h};delete c.cover;const y=()=>{T(!1)},v=()=>{var u;d||(M(),j([]),l("media",[]),l("category",[]),(u=a==null?void 0:a.commands)==null||u.clearContent(!0))};d?$.post(route("admin.news.update",{news:t.id}),{...c,_method:"PUT"},{forceFormData:!0,onFinish:y,onSuccess:v}):(console.log("Отправка формы создания новости (Form.jsx):",{title:c.title,body_length:((O=c.body)==null?void 0:O.length)||0,category_count:((R=c.category)==null?void 0:R.length)||0,status:c.status,media_count:b.length,type:c.type}),$.post(route("admin.news.store"),c,{forceFormData:!0,onFinish:y,onSuccess:v,onError:u=>{if(console.error("Ошибки валидации в Form.jsx:",u),u&&(Object.keys(u).forEach(U=>{console.error(`Ошибка в поле ${U}:`,u[U])}),u.error&&u.error.includes("419")||typeof u=="object"&&u.status===419)){alert("Сессия истекла. Страница будет обновлена."),window.location.reload();return}},onCancel:()=>{console.log("Запрос отменен")}}))},[o,b,d,t==null?void 0:t.id,a,M,l,h]),z=n.useCallback(()=>{T(!0),L(null,"published")},[L]);return e.jsx(Q,{title:r==null?void 0:r.title,children:e.jsx("div",{className:"py-8",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:d?(r==null?void 0:r.editLabel)||"Редактировать новость":(r==null?void 0:r.createLabel)||"Создать новость"}),(r==null?void 0:r.subtitle)&&e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:r.subtitle}),e.jsxs(B,{href:A,className:"mt-2 inline-flex items-center text-sm text-blue-600 hover:text-blue-800",children:[e.jsx("span",{className:"mr-2",children:"←"}),(r==null?void 0:r.returnLabel)||"Вернуться к списку"]})]}),e.jsxs("form",{onSubmit:s=>L(s),className:"space-y-6",children:[e.jsxs("div",{className:"bg-white shadow rounded-lg p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx(p,{htmlFor:"title",value:"Заголовок *"}),e.jsx(N,{id:"title",type:"text",value:o.title,onChange:s=>l("title",s.target.value),className:"mt-1 block w-full",required:!0}),e.jsx(g,{message:m.title,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(p,{htmlFor:"slug",value:"URL-адрес (slug)"}),e.jsx("button",{type:"button",onClick:K,className:"text-sm text-blue-600 hover:text-blue-800",children:"Обновить из заголовка"})]}),e.jsx(N,{id:"slug",type:"text",value:o.slug,onChange:s=>l("slug",s.target.value),className:"mt-1 block w-full",placeholder:"Автоматически генерируется из заголовка"}),e.jsx(g,{message:m.slug,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(p,{htmlFor:"excerpt",value:"Краткое описание"}),e.jsx("textarea",{id:"excerpt",value:o.excerpt,onChange:s=>l("excerpt",s.target.value),className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",rows:3,placeholder:"Краткое описание новости для превью..."}),e.jsx(g,{message:m.excerpt,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(p,{htmlFor:"body",value:"Текст новости *"}),e.jsxs("div",{className:"mt-1 border border-gray-300 rounded-md",children:[a&&e.jsxs("div",{className:"border-b border-gray-200 p-2 flex flex-wrap gap-2",children:[e.jsx("button",{type:"button",onClick:()=>a.chain().focus().toggleBold().run(),className:`px-3 py-1 rounded text-sm ${a.isActive("bold")?"bg-gray-200 font-semibold":"hover:bg-gray-100"}`,children:"Жирный"}),e.jsx("button",{type:"button",onClick:()=>a.chain().focus().toggleItalic().run(),className:`px-3 py-1 rounded text-sm italic ${a.isActive("italic")?"bg-gray-200":"hover:bg-gray-100"}`,children:"Курсив"}),e.jsx("button",{type:"button",onClick:()=>a.chain().focus().toggleBulletList().run(),className:`px-3 py-1 rounded text-sm ${a.isActive("bulletList")?"bg-gray-200":"hover:bg-gray-100"}`,children:"Список"}),e.jsx("button",{type:"button",onClick:()=>a.chain().focus().setParagraph().run(),className:"px-3 py-1 rounded text-sm hover:bg-gray-100",children:"Абзац"})]}),e.jsx(se,{editor:a,className:"prose max-w-none p-4 min-h-[320px] focus:outline-none"})]}),e.jsx(g,{message:m.body,className:"mt-2"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx(p,{htmlFor:"seo_title",value:"SEO заголовок"}),e.jsx(N,{id:"seo_title",type:"text",value:o.seo_title,onChange:s=>l("seo_title",s.target.value),className:"mt-1 block w-full",placeholder:"Если не указано — используется основной заголовок"}),e.jsx(g,{message:m.seo_title,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(p,{htmlFor:"seo_description",value:"SEO описание"}),e.jsx("textarea",{id:"seo_description",value:o.seo_description,onChange:s=>l("seo_description",s.target.value),className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",rows:2,placeholder:"Если не указано — используется краткое описание"}),e.jsx(g,{message:m.seo_description,className:"mt-2"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx(p,{htmlFor:"status",value:"Статус *"}),e.jsxs("select",{id:"status",value:o.status,onChange:s=>l("status",s.target.value),className:"mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500",required:!0,children:[e.jsx("option",{value:"draft",children:"Черновик"}),e.jsx("option",{value:"published",children:"Опубликовано"})]}),e.jsx(g,{message:m.status,className:"mt-2"})]}),e.jsxs("div",{children:[e.jsx(p,{htmlFor:"published_at",value:"Дата и время публикации"}),e.jsx(N,{id:"published_at",type:"datetime-local",value:o.published_at,onChange:s=>l("published_at",s.target.value),className:"mt-1 block w-full"}),e.jsx(g,{message:m.published_at,className:"mt-2"})]})]})]}),e.jsxs("div",{className:"bg-white shadow rounded-lg p-6",children:[e.jsx("h2",{className:"text-lg font-medium text-gray-900 mb-4",children:"Категории"}),S.length===0?e.jsx("p",{className:"text-sm text-gray-500",children:"Список категорий пуст. Обратитесь к администратору для настройки."}):e.jsx(Y,{selectedCategories:o.category,onCategoriesChange:s=>l("category",s),availableCategories:S,maxCategories:5}),e.jsx(g,{message:m.category,className:"mt-2"})]}),e.jsxs("div",{className:"bg-white shadow rounded-lg p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-medium text-gray-900",children:"Галерея"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Загрузите дополнительные изображения или видео (поддерживаются форматы jpg, png, webp, mp4 и др.)."})]}),e.jsxs("span",{className:"text-sm text-gray-400",children:["Файлов: ",b.length]})]}),e.jsx(V,{existingMedia:b,onMediaUploaded:W,onMediaRemoved:X,maxFiles:30}),e.jsx(g,{message:m.media,className:"mt-2"})]}),e.jsxs("div",{className:"flex flex-wrap justify-end gap-4",children:[e.jsx(B,{href:A,className:"px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50",children:"Отмена"}),e.jsx(D,{type:"submit",disabled:F||E,className:"px-4 py-2",children:F?"Сохранение...":d?"Сохранить изменения":(r==null?void 0:r.createLabel)||"Создать запись"}),!d&&e.jsx(D,{type:"button",disabled:F||E,onClick:z,className:"px-4 py-2 bg-green-600 hover:bg-green-700",children:E?"Публикация...":"Сохранить и опубликовать"})]})]})]})})})}export{xe as default};
