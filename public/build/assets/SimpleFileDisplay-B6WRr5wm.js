import{r as d,j as t,b as ee}from"./app-Dx0pQLKn.js";function ve({folder:N="",title:S="",limit:D=0,searchTerm:u="",medicine:x="",mkb:h="",category:p="",year:j="",fileType:v="",type:F="",bgColor:te="bg-green-100",useClinicalProtocols:z=!1,onFilesLoaded:G=null,onError:m=null,singleColumn:se=!1,hideDownload:re=!1}){const[B,ne]=d.useState([]),[ae,f]=d.useState(!0),[H,L]=d.useState(null),[oe,J]=d.useState(!1),[i,K]=d.useState(null),[le,C]=d.useState(!1),[Y,U]=d.useState(null),[q,V]=d.useState(null);d.useState(null);const $=60,ce=60,[E,W]=d.useState($),[ie,de]=d.useState({}),y=e=>{if(!e||e==="NaN.NaN.NaN")return"";try{const r=new Date(e);if(isNaN(r.getTime()))return e;const a=String(r.getDate()).padStart(2,"0"),o=String(r.getMonth()+1).padStart(2,"0"),n=r.getFullYear();return`${a}.${o}.${n}`}catch{return e}},k=e=>{if(!e||e===0)return"0 Bytes";if(typeof e=="string"){if(e.includes("KB")||e.includes("MB")||e.includes("GB"))return e;if(e=parseInt(e,10),isNaN(e))return"0 Bytes"}const r=1024,a=["Bytes","KB","MB","GB"],o=Math.floor(Math.log(e)/Math.log(r));return parseFloat((e/Math.pow(r,o)).toFixed(1))+" "+a[o]};d.useEffect(()=>{(async()=>{try{f(!0);const r=window.location.origin,a=new URLSearchParams;let o=`${r}/api/files`;if(z){if(o=`${r}/api/clinical-protocols`,N){const s=N.replace(/\\/g,"/");a.append("folder",s)}u&&a.append("search",u)}else{if(N){const c=N.replace(/\\/g,"/");a.append("folder",c)}S&&a.append("title",S);let s=u||"";x&&(s+=` medicine:${x}`),h&&(s+=` mkb:${h}`),p&&(s+=` category:${p}`),F&&(s+=` type:${F}`),s.trim()!==""&&a.append("search",s.trim())}console.log(`Fetching files from: ${o}${a.toString()?"?"+a.toString():""}`),console.log("Search parameters:",{searchTerm:u,medicine:x,mkb:h,category:p,year:j,fileType:v,type:F,useClinicalProtocols:z,folder:N}),console.log(`Выполняем запрос к API: ${o}${a.toString()?"?"+a.toString():""}`);let n;try{if(n=await ee.get(`${o}${a.toString()?"?"+a.toString():""}`),console.log("API response получен:",n),console.log("API response data:",n.data),!n.data){const s="Ответ API не содержит данных";console.error(s),L("Ошибка при загрузке файлов: нет данных"),m&&m(s),f(!1);return}if(n.data.error){const s=`Ошибка API: ${n.data.error}`;console.error(s),L(s),m&&m(s),f(!1);return}}catch(s){const c=`Ошибка при загрузке файлов: ${s.message}`;console.error("Ошибка при запросе к API:",s),console.error("API Endpoint:",o),console.error("Search Parameters:",{searchTerm:u,medicine:x,mkb:h,category:p,year:j,fileType:v,type:F}),L(c),m&&m(c),f(!1);return}let l=[];if(z)if(console.log("Обрабатываем данные клинических протоколов:",n.data),n.data&&n.data.documents)console.log("Найдены документы в response.data.documents:",n.data.documents),l=n.data.documents;else if(n.data&&n.data.protocols)console.log("Найдены протоколы в response.data.protocols:",n.data.protocols),l=n.data.protocols;else{const s="Не найдены ни documents, ни protocols в ответе API. Response data: "+JSON.stringify(n.data);console.error(s),console.error("Full response:",n),m&&m(s),f(!1);return}else n.data&&Array.isArray(n.data)?n.data.forEach(s=>{s.files&&(l=[...l,...s.files]),s.documents&&(l=[...l,...s.documents])}):n.data&&n.data.files&&(l=n.data.files);console.log("Processed files data:",l);const M=l.map(s=>{if(!s.name&&s.url){const c=s.url.split("/"),g=c[c.length-1];return{...s,name:g}}return s}),b=D?M.slice(0,D):M;ne(b),W(Math.min($,b.length||$));const X=b.map(s=>s.url&&s.url!=="#"?z?Promise.resolve({id:s.id||s.url,size:s.size?k(s.size):s.filesize||"—",date:y(s.modified||s.date||s.created_at||"")}):ee.head(s.url).then(c=>{const g=c.headers["content-length"],_=c.headers["last-modified"];return{id:s.id||s.url,size:g?k(g):"0 Bytes",date:y(_?new Date(_):s.date||s.created_at||"")}}).catch(c=>(console.error("Error fetching file info:",c),{id:s.id||s.url,size:k(s.size||0),date:y(s.date||s.created_at||"")})):Promise.resolve({id:s.id||s.url,size:k(s.size||0),date:y(s.date||s.created_at||"")}));Promise.all(X).then(s=>{const c={};if(s.forEach((g,_)=>{c[b[_].id||b[_].url]=g}),de(c),G&&Array.isArray(l))try{G(l.length)}catch(g){console.error("Ошибка при вызове onFilesLoaded:",g),m&&m(`Ошибка при обработке данных: ${g.message}`)}f(!1)}).catch(s=>{console.error("Ошибка при загрузке файлов:",s),L("Ошибка при загрузке файлов. Пожалуйста, попробуйте позже."),f(!1)})}catch(r){console.error("Error fetching files:",r),L("Ошибка при загрузке файлов"),f(!1)}})()},[N,S,D,u,x,h,p,j,v,z]);const ue=e=>{switch(R(e)){case"pdf":return"2";case"xls":case"xlsx":return"3";case"txt":return"4";case"ppt":case"pptx":return"5";case"doc":case"docx":return"1";case"mp4":case"avi":case"mov":return"6";case"jpg":case"jpeg":case"png":case"gif":return"7";default:return"1"}},me=e=>{const r=R(e);if(!r)return"";switch(r){case"pdf":return"PDF";case"doc":case"docx":return"DOCX";case"xls":case"xlsx":return"XLSX";case"ppt":case"pptx":return"PPTX";case"txt":return"TXT";case"mp4":case"avi":case"mov":return"MP4";case"jpg":case"jpeg":case"png":return"JPG";default:return r.toUpperCase()}},Q=e=>{if(!e)return null;const r=R(e);return r?["pdf"].includes(r)?"pdf":["jpg","jpeg","png","gif","webp"].includes(r)?"image":["doc","docx"].includes(r)?"word":["xls","xlsx"].includes(r)?"excel":["ppt","pptx"].includes(r)?"powerpoint":["txt"].includes(r)?"text":["mp4","avi","mov"].includes(r)?"video":null:null},O=e=>{if(e!=null&&e.name&&typeof e.name=="string"&&e.name.includes("."))return e.name;if(e!=null&&e.url&&typeof e.url=="string")try{const a=e.url.split("?")[0].split("/"),o=a[a.length-1];if(o.includes("."))return o}catch(r){console.warn("Не удалось извлечь имя файла из URL",r)}return(e==null?void 0:e.name)||""},R=e=>{if(e!=null&&e.filetype&&typeof e.filetype=="string")return e.filetype.replace(".","").toLowerCase();if(e!=null&&e.extension&&typeof e.extension=="string")return e.extension.replace(".","").toLowerCase();const r=O(e);return r?r.split(".").pop().toLowerCase():""},xe=e=>!e||e==="#"?"":e.startsWith("http://")||e.startsWith("https://")?e:`${window.location.origin}${e.startsWith("/")?"":"/"}${e}`,he=e=>{try{C(!0),V(null);const r=e.url||"",a=xe(r),n=`https://docs.google.com/viewer?url=${encodeURIComponent(a)}&embedded=true`;return U(n),C(!1),n}catch(r){return console.error("Ошибка при конвертации документа:",r),V("Не удалось подготовить документ для просмотра"),C(!1),null}},pe=(e,r)=>{r&&r.preventDefault(),console.log("Opening file:",e),K(e),J(!0),document.body.style.overflow="hidden";const a=O(e);console.log("File name for determining type:",a);const o=Q(a);console.log("Detected file type:",o),["word","excel","powerpoint"].includes(o)?he(e):o==="video"&&typeof onVideoClick=="function"?(onVideoClick(e.url,e.description||e.name||"Видео"),I()):U(null)},I=()=>{J(!1),document.body.style.overflow="auto",K(null),U(null),C(!1),V(null)},P=e=>typeof e=="string"?e.trim().toLowerCase():"",w=d.useMemo(()=>(!u||u.trim()==="")&&!x&&!h&&!p&&!j&&!v?B:B.filter(e=>{const r=Array.isArray(e.medicine_categories)&&e.medicine_categories.length?e.medicine_categories:e.medicine?[e.medicine]:[],a=Array.isArray(e.mkb_codes)&&e.mkb_codes.length?e.mkb_codes:e.mkb?[e.mkb]:[];if(u&&u.trim()!==""){const o=u.toLowerCase().trim(),n=(e.name||"").toLowerCase(),l=(e.description||"").toLowerCase();if(!n.includes(o)&&!l.includes(o))return!1}if(x){const o=P(x);if(!r.some(l=>P(l)===o))return!1}if(h){const o=P(h);if(!a.some(l=>P(l)===o))return!1}return!(p&&e.category!==p||j&&e.year!==parseInt(j)||v&&e.filetype!==v.toLowerCase())}),[B,u,x,h,p,j,v,F]),T=w.length;d.useEffect(()=>{W(Math.min($,T||$))},[T]);const Z=d.useMemo(()=>w.slice(0,E),[w,E]),ge=E<w.length,fe=()=>{W(e=>Math.min(e+ce,w.length))};if(ae)return t.jsxs("div",{className:"py-8 text-center",children:[t.jsx("div",{className:"inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-green-500"}),t.jsx("p",{className:"mt-2","data-translate":!0,children:"Загрузка файлов..."})]});const A=i?Q(i):null;return H?t.jsx("div",{className:"py-8 text-center text-red-500",children:H}):t.jsxs("div",{className:`py-6 ${te}`,children:[S&&t.jsx("div",{className:"mb-4",children:t.jsx("h2",{className:"text-2xl font-semibold text-gray-800",children:S})}),w.length===0?t.jsx("div",{className:"py-8 text-center text-gray-500 bg-white rounded-lg shadow border border-gray-200","data-translate":!0,children:"Нет доступных документов"}):t.jsx("div",{className:`grid ${se?"grid-cols-1":"grid-cols-1 md:grid-cols-2 lg:grid-cols-3"} gap-4`,children:Z.map((e,r)=>{O(e);const a=e.description||e.name||"Файл",o=e.id||e.url,n=e.filesize?typeof e.filesize=="string"?e.filesize:k(e.filesize):e.size?k(e.size):"—",l=y(e.modified||e.date||e.created_at||""),M=ie[o]||{size:n,date:l},b=me(e),X=ue(e);return t.jsx("div",{className:"w-full",children:t.jsxs("div",{className:"flex flex-col h-[250px] bg-white p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200 border border-gray-200",children:[t.jsxs("div",{className:"flex-grow overflow-hidden",children:[t.jsx("h2",{className:"font-medium leading-normal text-gray-800 line-clamp-4 mb-3",children:a}),t.jsxs("div",{className:"flex flex-wrap gap-1 mb-2",children:[(Array.isArray(e.medicine_categories)&&e.medicine_categories.length?e.medicine_categories:e.medicine?[e.medicine]:[]).map((s,c)=>t.jsxs("span",{className:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800",children:["Раздел: ",s]},`med-${c}`)),(Array.isArray(e.mkb_codes)&&e.mkb_codes.length?e.mkb_codes:e.mkb?[e.mkb]:[]).map((s,c)=>t.jsxs("span",{className:"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800",children:["МКБ: ",s]},`mkb-${c}`))]})]}),t.jsxs("div",{className:"flex mt-auto justify-between items-center",children:[t.jsxs("div",{className:"flex space-x-2",children:[t.jsx("button",{onClick:s=>pe(e,s),className:"cursor-pointer text-black inline-flex items-center border-gray-300 border rounded-lg px-3 py-2 text-sm hover:bg-gray-50 transition-colors duration-200",children:t.jsx("span",{"data-translate":!0,children:"Открыть"})}),!re&&t.jsx("a",{href:e.url,download:!0,className:"cursor-pointer text-black inline-flex items-center border-gray-300 border rounded-lg px-3 py-2 text-sm hover:bg-gray-50 transition-colors duration-200",children:t.jsx("span",{"data-translate":!0,children:"Скачать"})})]}),t.jsxs("div",{className:"flex flex-col text-xs text-gray-600 text-right leading-tight",children:[t.jsxs("div",{className:"flex items-center justify-end gap-1",children:[t.jsx("img",{src:`/img/FileType/${X}.png`,alt:"",className:"w-4 h-4"}),t.jsx("span",{className:"uppercase",children:b})]}),t.jsx("span",{children:M.size}),M.date&&t.jsx("span",{className:"text-gray-400",children:M.date})]})]})]})},r)})}),t.jsxs("div",{className:"mt-4 text-sm text-gray-500 text-center",children:["Показано ",Z.length," из ",w.length]}),ge&&t.jsx("div",{className:"mt-4 flex justify-center",children:t.jsx("button",{onClick:fe,className:"px-6 py-2 bg-gray-100 border border-gray-300 rounded-lg text-sm text-gray-700 hover:bg-gray-200 transition-colors duration-200",children:"Показать ещё"})}),oe&&i&&t.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50",onClick:I,children:t.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-5xl w-full max-h-[90vh] flex flex-col",onClick:e=>e.stopPropagation(),children:[t.jsxs("div",{className:"flex justify-between items-center p-4 border-b",children:[t.jsx("h3",{className:"text-xl font-semibold text-gray-800 truncate",children:i.description||i.name||"Файл"}),t.jsx("button",{onClick:I,className:"text-gray-500 hover:text-gray-700 focus:outline-none",children:t.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M6 18L18 6M6 6l12 12"})})})]}),t.jsx("div",{className:"flex-grow p-4 overflow-auto",children:le?t.jsxs("div",{className:"flex flex-col items-center justify-center h-[70vh]",children:[t.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-gray-900 mb-4"}),t.jsx("p",{className:"text-gray-600","data-translate":!0,children:"Подготовка документа к просмотру..."})]}):q?t.jsxs("div",{className:"flex flex-col items-center justify-center h-[70vh]",children:[t.jsx("div",{className:"text-red-500 mb-4",children:t.jsx("svg",{className:"w-16 h-16",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})}),t.jsx("p",{className:"text-gray-600 mb-4",children:q}),t.jsx("a",{href:i.url,target:"_blank",rel:"noopener noreferrer",className:"bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors duration-200",children:"Скачать файл"})]}):A==="image"?t.jsx("div",{className:"flex items-center justify-center h-[70vh]",children:t.jsx("img",{src:i.url,alt:i.description||i.name,className:"max-w-full max-h-[70vh] object-contain"})}):A==="pdf"?t.jsx("div",{className:"flex flex-col items-center justify-center h-[70vh]",children:t.jsx("div",{className:"w-full h-full",children:t.jsx("object",{data:i.url,type:"application/pdf",className:"w-full h-full min-h-[70vh]",children:t.jsxs("p",{children:["Ваш браузер не поддерживает встроенный просмотр PDF.",t.jsx("a",{href:i.url,target:"_blank",rel:"noopener noreferrer",children:"Скачайте PDF"}),"."]})})})}):A==="video"?t.jsx("div",{className:"flex flex-col items-center justify-center h-[70vh]",children:t.jsx("div",{className:"w-full h-full",children:t.jsx("video",{src:i.url,className:"max-w-full max-h-[70vh]",controls:!0,autoPlay:!0})})}):["word","excel","powerpoint"].includes(A)&&Y?t.jsx("div",{className:"flex flex-col items-center justify-center h-[70vh]",children:t.jsx("div",{className:"w-full h-full",children:t.jsx("iframe",{src:Y,className:"w-full h-full min-h-[70vh]",title:i.description||i.name,frameBorder:"0"})})}):["word","excel","powerpoint"].includes(A)?t.jsxs("div",{className:"flex flex-col items-center justify-center h-[70vh]",children:[t.jsx("div",{className:"text-blue-500 mb-4",children:t.jsx("svg",{className:"w-16 h-16",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})})}),t.jsx("p",{className:"text-gray-600 mb-4",children:"Предпросмотр для этого типа файла недоступен"}),t.jsx("a",{href:i.url,target:"_blank",rel:"noopener noreferrer",className:"bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors duration-200",children:"Скачать файл"})]}):t.jsxs("div",{className:"flex flex-col items-center justify-center h-[70vh]",children:[t.jsx("div",{className:"text-gray-500 mb-4",children:t.jsx("svg",{className:"w-16 h-16",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})})}),t.jsx("p",{className:"text-gray-600 mb-4",children:"Предпросмотр для этого типа файла недоступен"}),t.jsx("a",{href:i.url,target:"_blank",rel:"noopener noreferrer",className:"bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors duration-200",children:"Скачать файл"})]})}),t.jsxs("div",{className:"p-4 border-t flex justify-end",children:[t.jsx("a",{href:i.url,target:"_blank",rel:"noopener noreferrer",className:"bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-lg mr-2 transition-colors duration-200",children:"Открыть в новой вкладке"}),t.jsx("button",{onClick:I,className:"bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors duration-200",children:"Закрыть"})]})]})})]})}export{ve as S};
