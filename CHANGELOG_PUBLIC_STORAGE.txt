═══════════════════════════════════════════════════════════════
ИЗМЕНЕНИЯ: ПЕРЕХОД НА ХРАНЕНИЕ ФАЙЛОВ В PUBLIC
Дата: 23 октября 2025
═══════════════════════════════════════════════════════════════

ПРОБЛЕМА:
---------
При просмотре файлов из форм обратной связи в админке на хостинге
возникала ошибка 403 (Доступ запрещен).

ПРИЧИНА:
--------
Файлы сохранялись в storage/app/public/, что требовало создания
символической ссылки public/storage -> ../storage/app/public.
На некоторых хостингах симлинки создаются неправильно или вообще
не поддерживаются.

РЕШЕНИЕ:
--------
Изменен путь хранения файлов с storage/app/public/ на public/
для прямого доступа без использования символических ссылок.

═══════════════════════════════════════════════════════════════
ТЕХНИЧЕСКИЕ ИЗМЕНЕНИЯ
═══════════════════════════════════════════════════════════════

1. КОНФИГУРАЦИЯ ФАЙЛОВОЙ СИСТЕМЫ
   Файл: config/filesystems.php
   
   Добавлен новый диск 'public_direct':
   
   'public_direct' => [
       'driver' => 'local',
       'root' => public_path(),
       'url' => env('APP_URL'),
       'visibility' => 'public',
       'throw' => false,
   ],

2. КОНТРОЛЛЕР ФОРМ ОБРАТНОЙ СВЯЗИ
   Файл: app/Http/Controllers/ContactApplicationController.php
   
   Изменена строка 46:
   ❌ Было:  $file->storeAs('contact_attachments', $fileName, 'public');
   ✅ Стало: $file->storeAs('contact_attachments', $fileName, 'public_direct');
   
   Результат: Файлы сохраняются в public/contact_attachments/

3. КОНТРОЛЛЕР ВАКАНСИЙ
   Файл: app/Http/Controllers/VacancyApplicationController.php
   
   Изменена строка 47:
   ❌ Было:  $file->storeAs('resumes', $fileName, 'public');
   ✅ Стало: $file->storeAs('resumes', $fileName, 'public_direct');
   
   Результат: Файлы сохраняются в public/resumes/

4. КОНТРОЛЛЕР ОЦТК
   Файл: app/Http/Controllers/ContactController.php
   
   Изменена строка 44:
   ❌ Было:  $file->storeAs('tech-competence-files', $fileName, 'public');
   ✅ Стало: $file->storeAs('tech-competence-files', $fileName, 'public_direct');
   
   Результат: Файлы сохраняются в public/tech-competence-files/

5. АДМИН-КОНТРОЛЛЕР
   Файл: app/Http/Controllers/Admin/ContactApplicationController.php
   
   Изменена строка 133 (формирование URL):
   ❌ Было:  Storage::url($application->attachment_path)
   ✅ Стало: '/' . $application->attachment_path
   
   Изменена строка 210 (удаление файлов):
   ❌ Было:  Storage::disk('public')->delete($application->attachment_path)
   ✅ Стало: Storage::disk('public_direct')->delete($application->attachment_path)

═══════════════════════════════════════════════════════════════
НОВЫЕ ФАЙЛЫ
═══════════════════════════════════════════════════════════════

1. public/contact_attachments/.htaccess
   Защита папки с вложениями форм

2. public/resumes/.htaccess
   Защита папки с резюме

3. public/tech-competence-files/.htaccess
   Защита папки с файлами ОЦТК

4. migrate_files_to_public.php
   Скрипт для переноса существующих файлов

5. PUBLIC_STORAGE_SETUP.txt
   Полная документация по настройке

6. DEPLOY_PUBLIC_STORAGE.txt
   Краткая инструкция для развертывания

7. CHANGELOG_PUBLIC_STORAGE.txt (этот файл)
   Список изменений

═══════════════════════════════════════════════════════════════
УДАЛЕННЫЕ ФАЙЛЫ
═══════════════════════════════════════════════════════════════

1. CONTACT_FORMS_STORAGE_SETUP.txt (устарела)
2. QUICK_FIX_HOSTING.txt (устарела)
3. STORAGE_FIX_INSTRUCTIONS.txt (устарела)
4. public/test_storage.php (тестовый файл)

═══════════════════════════════════════════════════════════════
СТРУКТУРА ХРАНЕНИЯ ФАЙЛОВ
═══════════════════════════════════════════════════════════════

НОВАЯ СТРУКТУРА (С 23.10.2025):
-------------------------------
public/
├── contact_attachments/          ← Вложения форм (ИЗМЕНЕНО)
│   ├── .htaccess
│   └── 1234567890_file.pdf
├── resumes/                       ← Резюме (ИЗМЕНЕНО)
│   ├── .htaccess
│   └── 1234567890_resume.pdf
├── tech-competence-files/         ← Файлы ОЦТК (ИЗМЕНЕНО)
│   ├── .htaccess
│   └── 1234567890_document.pdf
└── storage/                       ← Symlink (для новостей, документов)
    ├── news/                      (НЕ ИЗМЕНЕНО)
    ├── documents/                 (НЕ ИЗМЕНЕНО)
    └── videos/                    (НЕ ИЗМЕНЕНО)

СТАРАЯ СТРУКТУРА (ДО 23.10.2025):
---------------------------------
storage/app/public/
├── contact_attachments/          ← Старое расположение
├── resumes/                       ← Старое расположение
└── tech-competence-files/         ← Старое расположение

═══════════════════════════════════════════════════════════════
ФОРМИРОВАНИЕ URL
═══════════════════════════════════════════════════════════════

ФАЙЛЫ ФОРМ (НОВЫЕ):
-------------------
Путь в БД:      contact_attachments/1234567890_file.pdf
URL:            /contact_attachments/1234567890_file.pdf
Физический путь: public/contact_attachments/1234567890_file.pdf

ИЗОБРАЖЕНИЯ НОВОСТЕЙ (НЕ ИЗМЕНЕНО):
-----------------------------------
Путь в БД:      news/1234567890_image.jpg
URL:            /storage/news/1234567890_image.jpg
Физический путь: storage/app/public/news/1234567890_image.jpg

═══════════════════════════════════════════════════════════════
МИГРАЦИЯ СУЩЕСТВУЮЩИХ ФАЙЛОВ
═══════════════════════════════════════════════════════════════

НА ЛОКАЛЬНОЙ МАШИНЕ (ВЫПОЛНЕНО):
--------------------------------
✅ Скопировано 8 файлов из storage/app/public в public/
   - 1 файл: contact_attachments
   - 1 файл: resumes
   - 6 файлов: tech-competence-files

НА ХОСТИНГЕ (НУЖНО ВЫПОЛНИТЬ):
------------------------------
1. Загрузите migrate_files_to_public.php на хостинг
2. Запустите: php migrate_files_to_public.php
3. Проверьте работу файлов в админке
4. Удалите старые файлы из storage/app/public/

═══════════════════════════════════════════════════════════════
ПРЕИМУЩЕСТВА НОВОГО ПОДХОДА
═══════════════════════════════════════════════════════════════

✅ Не требуется символическая ссылка
✅ Работает на любом хостинге (включая Windows)
✅ Не нужно настраивать права доступа для symlink
✅ Прямой доступ к файлам через URL
✅ Нет ошибки 403
✅ Проще для понимания и отладки
✅ Меньше зависимостей от конфигурации сервера

═══════════════════════════════════════════════════════════════
БЕЗОПАСНОСТЬ
═══════════════════════════════════════════════════════════════

ЗАЩИТА ПАПОК:
-------------
✅ .htaccess запрещает листинг директорий (Options -Indexes)
✅ Доступ разрешен только к определенным типам файлов
✅ Запрещено выполнение PHP файлов
✅ Уникальные имена файлов (timestamp + оригинальное имя)

РАЗРЕШЕННЫЕ ТИПЫ:
-----------------
- contact_attachments: pdf, doc, docx, jpg, jpeg, png, txt
- resumes: pdf, doc, docx
- tech-competence-files: pdf, doc, docx, ppt, pptx

═══════════════════════════════════════════════════════════════
ТЕСТИРОВАНИЕ
═══════════════════════════════════════════════════════════════

НА ЛОКАЛЬНОЙ МАШИНЕ:
--------------------
✅ Миграция файлов выполнена
✅ .htaccess файлы созданы
✅ Код обновлен

НА ХОСТИНГЕ (ПОСЛЕ РАЗВЕРТЫВАНИЯ):
----------------------------------
☐ Загрузить обновленные файлы
☐ Создать папки
☐ Установить права доступа
☐ Запустить миграцию
☐ Проверить доступ к файлам в админке
☐ Проверить загрузку новых файлов

═══════════════════════════════════════════════════════════════
ОБРАТНАЯ СОВМЕСТИМОСТЬ
═══════════════════════════════════════════════════════════════

СУЩЕСТВУЮЩИЕ ЗАПИСИ В БД:
-------------------------
✅ Совместимы! Пути в БД не изменились
   Было:  contact_attachments/1234567890_file.pdf
   Стало: contact_attachments/1234567890_file.pdf

СТАРЫЕ ФАЙЛЫ:
-------------
✅ Будут скопированы скриптом миграции
✅ После проверки можно удалить из storage/app/public/

ИЗОБРАЖЕНИЯ НОВОСТЕЙ:
--------------------
✅ НЕ ЗАТРОНУТЫ, остались в storage/app/public/news/

═══════════════════════════════════════════════════════════════
КОНТРОЛЬНЫЙ СПИСОК ДЛЯ РАЗВЕРТЫВАНИЯ
═══════════════════════════════════════════════════════════════

☐ 1. Сделать резервную копию базы данных
☐ 2. Сделать резервную копию storage/app/public/
☐ 3. Загрузить обновленные файлы на хостинг
☐ 4. Создать папки в public/
☐ 5. Установить права доступа
☐ 6. Загрузить .htaccess файлы
☐ 7. Запустить migrate_files_to_public.php
☐ 8. Проверить работу в админке
☐ 9. Протестировать загрузку новых файлов
☐ 10. Удалить старые файлы из storage/app/public/

═══════════════════════════════════════════════════════════════
ДОПОЛНИТЕЛЬНАЯ ИНФОРМАЦИЯ
═══════════════════════════════════════════════════════════════

Документация:
- PUBLIC_STORAGE_SETUP.txt - полная инструкция
- DEPLOY_PUBLIC_STORAGE.txt - краткая инструкция

Скрипты:
- migrate_files_to_public.php - миграция файлов

Автор изменений: AI Assistant
Дата: 23 октября 2025

═══════════════════════════════════════════════════════════════

