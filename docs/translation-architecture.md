# Архитектура системы переводов

## Обзор

Система переводов сайта НЦЭЛС построена на принципах кэширования, исключений и массового перевода. Она обеспечивает быстрый доступ к переводам и корректную обработку специальных терминов и имен собственных.

## Компоненты системы

### 1. База данных (`stored_translations`)

**Структура таблицы:**
```sql
CREATE TABLE stored_translations (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    original_text TEXT NOT NULL,           -- Оригинальный текст на русском
    translated_text TEXT NOT NULL,         -- Переведенный текст
    target_language VARCHAR(5) NOT NULL,   -- Язык перевода (en, kz)
    page_url VARCHAR(255) NULL,            -- URL страницы для контекста
    hash VARCHAR(64) NOT NULL,             -- Хеш для быстрого поиска
    is_verified BOOLEAN DEFAULT FALSE,     -- Проверен ли перевод вручную
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    
    INDEX idx_language_hash (target_language, hash),
    INDEX idx_page_url (page_url)
);
```

**Принципы работы:**
- Хеш генерируется как `md5(original_text + '_' + target_language)`
- Один оригинальный текст может иметь переводы на разные языки
- URL страницы помогает группировать переводы по контексту
- Флаг `is_verified` позволяет отмечать проверенные переводы

### 2. Модель `StoredTranslation`

**Основные методы:**
- `generateHash()` - создание хеша для поиска
- `findTranslation()` - поиск перевода по тексту и языку
- `updateOrCreate()` - создание или обновление перевода

### 3. Сервис `TranslationService`

**Основные методы:**
- `translate()` - основной метод перевода с проверкой исключений и кэша
- `saveTranslation()` - сохранение перевода в БД
- `translateBatch()` - массовый перевод текстов
- `getPageTranslations()` - получение переводов для страницы
- `getTranslationStats()` - статистика переводов

**Алгоритм перевода:**
1. Проверка языка (если русский - возврат как есть)
2. Проверка исключений (`TranslationExceptionsService`)
3. Поиск в БД кэше
4. Перевод через Google Translate API
5. Сохранение в БД

### 4. Сервис исключений `TranslationExceptionsService`

**Категории исключений:**
- `names` - имена собственные (Салидат Каирбекова, города)
- `abbreviations` - аббревиатуры (НЦЭЛС, ВОЗ, МЗ РК)
- `technical` - технические термины
- `organizations` - названия организаций

**Функции:**
- `checkException()` - проверка исключения
- `addException()` - добавление исключения
- `removeException()` - удаление исключения
- `getExceptionsForLanguage()` - получение исключений для языка

### 5. Контроллер `TranslationController`

**Методы:**
- `index()` - панель управления переводами
- `translateAll()` - массовый перевод всего контента
- `getPageTranslations()` - API для получения переводов страницы
- `deleteTranslation()` - удаление перевода
- `updateTranslation()` - обновление перевода

### 6. Команда `ManageTranslationExceptions`

**Доступные действия:**
```bash
# Просмотр всех исключений
php artisan translations:exceptions list

# Добавление исключения
php artisan translations:exceptions add --original="текст" --translated="перевод" --language="kz"

# Удаление исключения
php artisan translations:exceptions remove --original="текст"

# Очистка кэша
php artisan translations:exceptions clear-cache
```

## Процесс работы системы

### 1. Первоначальная настройка

1. **Создание исключений:**
   ```bash
   php artisan translations:exceptions add --original="Салидат Каирбековой" --translated="Салидат Каирбекова" --language="kz"
   ```

2. **Массовый перевод контента:**
   - Через админ-панель: `/admin/translations`
   - Кнопка "Перевести весь контент"
   - Автоматический сбор текстов из новостей и других источников

### 2. Повседневная работа

1. **При загрузке страницы:**
   - Система собирает все тексты на странице
   - Для каждого текста проверяется наличие перевода в БД
   - Если перевода нет - создается новый через Google Translate

2. **При переключении языка:**
   - Загружаются переводы из БД для текущей страницы
   - Применяются исключения
   - Тексты заменяются в DOM

### 3. Кэширование

**Уровни кэширования:**
1. **БД кэш** - все переводы сохраняются в `stored_translations`
2. **Исключения кэш** - исключения кэшируются в Redis/Memcached
3. **Страничный кэш** - переводы страницы кэшируются в сессии

## API Endpoints

### 1. Получение переводов страницы
```http
POST /api/translate-batch
Content-Type: application/json

{
    "page_url": "/about",
    "target_language": "kz"
}
```

### 2. Массовый перевод
```http
POST /admin/translations/translate-all
Content-Type: application/json

{
    "target_language": "kz"
}
```

## Мониторинг и статистика

### 1. Статистика переводов
- Количество переводов по языкам
- Процент проверенных переводов
- Популярные страницы

### 2. Логирование
- Ошибки Google Translate API
- Новые переводы
- Использование исключений

### 3. Админ-панель
- Просмотр всех переводов
- Редактирование переводов
- Управление исключениями
- Статистика использования

## Безопасность

### 1. Валидация входных данных
- Проверка поддерживаемых языков
- Санитизация текстов
- Ограничение длины текстов

### 2. Ограничения API
- Rate limiting для Google Translate
- Максимальный размер текста
- Тайм-ауты запросов

### 3. Кэш безопасности
- Проверка целостности кэша
- Автоматическая очистка устаревших данных
- Резервное копирование переводов

## Расширение системы

### 1. Добавление нового языка
1. Добавить код языка в `$supportedLanguages`
2. Создать исключения для нового языка
3. Обновить интерфейс

### 2. Добавление новых источников контента
1. Расширить метод `extractOtherTexts()` в `TranslationController`
2. Добавить новые модели в процесс сбора текстов

### 3. Интеграция с другими переводчиками
1. Создать интерфейс `TranslationProvider`
2. Реализовать адаптеры для разных API
3. Добавить fallback механизм

## Производительность

### 1. Оптимизации
- Индексы в БД для быстрого поиска
- Кэширование исключений
- Batch операции для массовых переводов
- Lazy loading переводов

### 2. Мониторинг
- Время ответа API
- Использование памяти
- Количество запросов к Google Translate
- Hit rate кэша

## Заключение

Система переводов обеспечивает:
- ✅ Быстрый доступ к переводам через кэширование
- ✅ Корректную обработку имен собственных через исключения
- ✅ Масштабируемость и расширяемость
- ✅ Удобное управление через админ-панель
- ✅ Мониторинг и статистику использования

Архитектура позволяет легко добавлять новые языки, источники контента и интеграции с другими переводчиками.
